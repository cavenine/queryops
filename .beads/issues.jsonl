{"id":"queryops-005","title":"[Phase 3] Add integration tests for SSE streaming with pub/sub","description":"Create integration tests that verify end-to-end SSE streaming with pub/sub.\n\n**File:** `features/osquery/handlers_integration_test.go` (new file)\n\n**Test setup:**\n```go\n//go:build integration\n\npackage osquery_test\n\nimport (\n    \"testing\"\n    \n    \"github.com/cavenine/queryops/internal/pubsub\"\n    \"github.com/cavenine/queryops/internal/testdb\"\n    // ...\n)\n```\n\n**Test cases:**\n\n1. **TestHostResultsSSE_ReceivesPublishedEvents**\n```go\nfunc TestHostResultsSSE_ReceivesPublishedEvents(t *testing.T) {\n    pool := testdb.NewPool(t)\n    ps, _ := pubsub.New(context.Background(), pool, nil)\n    defer ps.Close()\n    \n    repo := services.NewHostRepository(pool)\n    handlers := osquery.NewHandlers(repo, nil, ps.Publisher(), ps)\n    \n    // Create test host\n    hostID := createTestHost(t, pool)\n    \n    // Start SSE connection in goroutine\n    ctx, cancel := context.WithCancel(context.Background())\n    defer cancel()\n    \n    received := make(chan string, 10)\n    go func() {\n        // Make SSE request, capture events\n        req := httptest.NewRequest(\"GET\", \"/hosts/\"+hostID.String()+\"/results\", nil)\n        req = req.WithContext(ctx)\n        w := \u0026sseRecorder{events: received}\n        handlers.HostResultsSSE(w, req)\n    }()\n    \n    // Wait for subscription to be ready\n    time.Sleep(200 * time.Millisecond)\n    \n    // Publish event\n    event := pubsub.QueryResultEvent{\n        HostID:     hostID,\n        QueryID:    uuid.New(),\n        Status:     \"completed\",\n        OccurredAt: time.Now(),\n    }\n    err := ps.Publisher().Publish(pubsub.TopicQueryResults(hostID), event.ToMessage())\n    require.NoError(t, err)\n    \n    // Verify SSE receives update\n    select {\n    case data := \u003c-received:\n        assert.Contains(t, data, \"host-results-container\")\n    case \u003c-time.After(2 * time.Second):\n        t.Fatal(\"timeout waiting for SSE update\")\n    }\n}\n```\n\n2. **TestHostResultsSSE_MultipleSubscribers_AllReceive**\n```go\nfunc TestHostResultsSSE_MultipleSubscribers_AllReceive(t *testing.T) {\n    // Start 3 SSE connections for same host\n    // Publish 1 event\n    // Verify all 3 receive update\n}\n```\n\n3. **TestHostResultsSSE_DifferentHosts_Isolated**\n```go\nfunc TestHostResultsSSE_DifferentHosts_Isolated(t *testing.T) {\n    // SSE connection for host A\n    // SSE connection for host B\n    // Publish event for host A\n    // Verify only host A connection receives update\n}\n```\n\n4. **TestHostResultsSSE_ContextCancellation_CleansUp**\n```go\nfunc TestHostResultsSSE_ContextCancellation_CleansUp(t *testing.T) {\n    // Start SSE connection\n    // Cancel context\n    // Verify subscriber closed\n    // Verify no goroutine leaks\n}\n```\n\n**Helper types:**\n```go\n// sseRecorder captures SSE events for testing\ntype sseRecorder struct {\n    events chan string\n    // Implement http.ResponseWriter\n}\n\nfunc (r *sseRecorder) Write(p []byte) (int, error) {\n    r.events \u003c- string(p)\n    return len(p), nil\n}\n// ... other ResponseWriter methods ...\n```\n\n**Build tags:**\n- Use `//go:build integration` to separate from unit tests\n- Run with `go test -tags=integration ./...`\n\n**Acceptance Criteria:**\n- Tests pass with real PostgreSQL\n- Tests are isolated (unique hosts per test)\n- Tests don't leak goroutines\n- Tests have reasonable timeouts\n- Tests clean up resources\n\n**Dependencies:**\n- testdb package\n- pubsub package\n- SSE handler refactored","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:44:03.064398416-05:00","updated_at":"2025-12-20T22:28:14.306742233-05:00","closed_at":"2025-12-20T22:28:14.306742233-05:00","close_reason":"Superseded by campaign-based design - need new SSE tests for campaign topics","dependencies":[{"issue_id":"queryops-005","depends_on_id":"queryops-dr2","type":"blocks","created_at":"2025-12-20T20:46:40.917793316-05:00","created_by":"daemon"},{"issue_id":"queryops-005","depends_on_id":"queryops-8i6","type":"blocks","created_at":"2025-12-20T20:46:40.951914606-05:00","created_by":"daemon"}]}
{"id":"queryops-02p","title":"Fix G115 issues","description":"Address potential integer overflow in integer conversions in user repository and counter handlers","status":"closed","issue_type":"task","created_at":"2025-12-17T23:01:00.478413872-05:00","updated_at":"2025-12-17T23:22:02.506436818-05:00","closed_at":"2025-12-17T23:22:02.506436818-05:00","dependencies":[{"issue_id":"queryops-02p","depends_on_id":"queryops-8tj","type":"parent-child","created_at":"2025-12-17T23:01:03.343104437-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-05n","title":"Create account settings page","description":"New settings.templ page at /account. Lists user info (email) and registered passkeys with names/dates. Include 'Add Passkey' button and 'Remove' buttons for each credential.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T17:27:28.598024432-05:00","updated_at":"2025-12-12T19:29:51.893030563-05:00","closed_at":"2025-12-12T19:29:51.893030563-05:00","dependencies":[{"issue_id":"queryops-05n","depends_on_id":"queryops-pux","type":"parent-child","created_at":"2025-12-12T17:27:45.175300588-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-0io","title":"[Phase 2] Implement CampaignRepository with CRUD operations","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:28:20.441312443-05:00","updated_at":"2025-12-20T22:46:25.265323036-05:00","closed_at":"2025-12-20T22:46:25.265323036-05:00","close_reason":"Implemented core campaign repository methods on HostRepository (campaign_repository.go): get campaign by org, list campaigns by org, list campaign targets (joins hosts).","labels":["backend"],"dependencies":[{"issue_id":"queryops-0io","depends_on_id":"queryops-5k9","type":"blocks","created_at":"2025-12-20T22:28:44.412823561-05:00","created_by":"daemon"}]}
{"id":"queryops-0kg","title":"gofmt import grouping for organization_service.go","description":"features/organization/services/organization_service.go imports are not grouped/ordered per gofmt + repo conventions.\n\nProposed fix: run gofmt (or reorder imports) to match stdlib / external / internal grouping.\n\nTouch points: features/organization/services/organization_service.go","status":"closed","priority":4,"issue_type":"chore","created_at":"2025-12-19T14:29:26.335073185-05:00","updated_at":"2025-12-19T14:43:47.785140839-05:00","closed_at":"2025-12-19T14:43:47.785140839-05:00","close_reason":"Closed","labels":["severity:low"]}
{"id":"queryops-0qm","title":"[Phase 4] Add integration tests for campaign SSE streaming","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T22:28:35.110332034-05:00","updated_at":"2025-12-21T07:44:15.879205958-05:00","closed_at":"2025-12-21T07:44:15.879205958-05:00","close_reason":"Added SSE integration test (features/osquery/campaign_sse_integration_test.go) asserting CampaignResultsSSE emits Datastar patch events when a campaign message is published.","labels":["test"],"dependencies":[{"issue_id":"queryops-0qm","depends_on_id":"queryops-brx","type":"blocks","created_at":"2025-12-20T22:28:47.180101645-05:00","created_by":"daemon"}]}
{"id":"queryops-0qo","title":"[Phase 4] Update pubsub events for campaign-based topics","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:28:31.84683553-05:00","updated_at":"2025-12-20T22:41:12.183093065-05:00","closed_at":"2025-12-20T22:41:12.183093065-05:00","close_reason":"Added campaign topic helpers and CampaignResultEvent in internal/pubsub/events.go; kept host QueryResultEvent for backward compatibility; extended events tests.","labels":["backend"]}
{"id":"queryops-195","title":"Add Kamal migration hook","description":"Add .kamal/hooks/pre-deploy (or pre-app-boot) to run '/main migrate up' on primary host using new image version; disable AUTO_MIGRATE in deploy env.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-12T21:10:11.364379908-05:00","updated_at":"2025-12-12T21:14:11.990025821-05:00","closed_at":"2025-12-12T21:14:11.990025821-05:00","dependencies":[{"issue_id":"queryops-195","depends_on_id":"queryops-1ox","type":"parent-child","created_at":"2025-12-12T21:10:22.141108458-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-1ca","title":"[Phase 2] Modify DistributedWrite to publish events after saving results","description":"Update the DistributedWrite handler to publish a QueryResultEvent after successfully saving query results.\n\n**File:** `features/osquery/handlers.go`\n\n**Current flow (DistributedWrite):**\n```go\nfor queryIDStr, statusCode := range req.Statuses {\n    // ... parse queryID, determine status ...\n    \n    if err := h.repo.SaveQueryResults(ctx, host.ID, queryID, status, resJSON, errorText); err != nil {\n        slog.Error(\"failed to save query results\", \"error\", err)\n    }\n}\nh.jsonResponse(w, DistributedWriteResponse{})\n```\n\n**New flow:**\n```go\nimport (\n    \"github.com/cavenine/queryops/internal/pubsub\"\n)\n\nfor queryIDStr, statusCode := range req.Statuses {\n    // ... parse queryID, determine status ...\n    \n    if err := h.repo.SaveQueryResults(ctx, host.ID, queryID, status, resJSON, errorText); err != nil {\n        slog.Error(\"failed to save query results\", \"error\", err)\n        continue // Don't publish if save failed\n    }\n    \n    // NEW: Publish event for SSE subscribers\n    if h.publisher != nil {\n        event := pubsub.QueryResultEvent{\n            HostID:     host.ID,\n            QueryID:    queryID,\n            Status:     status,\n            OccurredAt: time.Now(),\n            Error:      errorText,\n        }\n        topic := pubsub.TopicQueryResults(host.ID)\n        if err := h.publisher.Publish(topic, event.ToMessage()); err != nil {\n            // Log but don't fail - results are saved, pub is best-effort\n            slog.Error(\"failed to publish query result event\",\n                \"error\", err,\n                \"host_id\", host.ID,\n                \"query_id\", queryID,\n            )\n        } else {\n            slog.Debug(\"published query result event\",\n                \"topic\", topic,\n                \"query_id\", queryID,\n                \"status\", status,\n            )\n        }\n    }\n}\nh.jsonResponse(w, DistributedWriteResponse{})\n```\n\n**Key design decisions:**\n1. **Best-effort publishing** - Publish failure doesn't fail the request. Results are saved, that's what matters.\n2. **Skip on save failure** - Don't publish if SaveQueryResults failed.\n3. **Nil check** - Graceful degradation when publisher not configured.\n4. **Debug logging** - Helps with troubleshooting without being noisy.\n\n**Error handling philosophy:**\n- The osquery agent successfully delivered results\n- Results are persisted to DB (primary goal)\n- SSE update is a nice-to-have (falls back to polling)\n- Returning error to agent would cause retry, duplicating results\n\n**Acceptance Criteria:**\n- Publishes event after successful save\n- Handles nil publisher gracefully\n- Publish failures logged but don't fail request\n- Topic format is query_results:{host_id}\n- Unit test with mock publisher verifies publish called\n\n**Test case:**\n```go\nfunc TestDistributedWrite_PublishesEventOnSuccess(t *testing.T) {\n    mockPublisher := \u0026MockPublisher{}\n    handlers := NewHandlers(mockRepo, mockOrgService, mockPublisher, nil)\n    \n    req := DistributedWriteRequest{\n        NodeKey:  \"valid-key\",\n        Statuses: map[string]int{queryID.String(): 0},\n        Queries:  map[string][]map[string]string{queryID.String(): {}},\n    }\n    \n    // ... make request ...\n    \n    assert.Equal(t, 1, mockPublisher.PublishCallCount)\n    assert.Contains(t, mockPublisher.LastTopic, hostID.String())\n}\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:42:37.973148829-05:00","updated_at":"2025-12-20T21:42:46.767557895-05:00","closed_at":"2025-12-20T21:42:46.767557895-05:00","close_reason":"DistributedWrite now publishes internal/pubsub.QueryResultEvent to topic query_results:{host_id} after successful SaveQueryResults (best-effort; skips on save error; nil publisher supported).","dependencies":[{"issue_id":"queryops-1ca","depends_on_id":"queryops-paz","type":"blocks","created_at":"2025-12-20T20:46:36.837629816-05:00","created_by":"daemon"},{"issue_id":"queryops-1ca","depends_on_id":"queryops-se3","type":"blocks","created_at":"2025-12-20T20:46:36.87338657-05:00","created_by":"daemon"}]}
{"id":"queryops-1cm","title":"Add /up healthcheck endpoint","description":"Expose unauthenticated GET /up returning 200 when ready (ideally with DB ping) so kamal-proxy healthcheck works.","status":"closed","issue_type":"feature","created_at":"2025-12-12T21:10:08.742053169-05:00","updated_at":"2025-12-12T21:14:05.66874881-05:00","closed_at":"2025-12-12T21:14:05.66874881-05:00","dependencies":[{"issue_id":"queryops-1cm","depends_on_id":"queryops-1ox","type":"parent-child","created_at":"2025-12-12T21:10:21.559927082-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-1mc","title":"Implement enroll secret rotation (single active secret)","description":"Org creation inserts a new active enroll secret but does not deactivate old secrets.\n\nImpact: secrets cannot be revoked; old secrets remain usable indefinitely after leak/rotation.\n\nProposed fix: deactivate previous secrets for org in same transaction when adding a new one; optionally enforce one-active-secret constraint.\n\nTouch points: features/organization/services/organization_repository.go AddEnrollSecret(), migrations/sql/20251219011627_organizations.*.sql","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T14:29:17.022238177-05:00","updated_at":"2025-12-19T14:37:45.175023724-05:00","closed_at":"2025-12-19T14:37:45.175023724-05:00","close_reason":"Closed","labels":["severity:medium"]}
{"id":"queryops-1ox","title":"Deploy QueryOps on DigitalOcean with Kamal","status":"closed","issue_type":"feature","created_at":"2025-12-12T21:10:02.696030122-05:00","updated_at":"2025-12-17T22:11:06.531139252-05:00","closed_at":"2025-12-17T22:11:06.531139252-05:00"}
{"id":"queryops-1sa","title":"Write DigitalOcean + Kamal deployment runbook","description":"Document droplet setup, firewall/ports, DNS, secrets, kamal setup/deploy, rollback, logs, and troubleshooting.","status":"closed","priority":1,"issue_type":"chore","created_at":"2025-12-12T21:10:17.605411895-05:00","updated_at":"2025-12-12T21:14:14.514092247-05:00","closed_at":"2025-12-12T21:14:14.514092247-05:00","dependencies":[{"issue_id":"queryops-1sa","depends_on_id":"queryops-1ox","type":"parent-child","created_at":"2025-12-12T21:10:22.458968356-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-2ia","title":"Fix errcheck issues","description":"Address unchecked errors in router/router.go and cmd/web/build/main.go","status":"closed","issue_type":"task","created_at":"2025-12-17T23:01:00.446187181-05:00","updated_at":"2025-12-17T23:09:19.758707416-05:00","closed_at":"2025-12-17T23:09:19.758707416-05:00","dependencies":[{"issue_id":"queryops-2ia","depends_on_id":"queryops-8tj","type":"parent-child","created_at":"2025-12-17T23:01:03.313690045-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-30m","title":"[Phase 3] Implement GET /api/v1/campaigns/{id} endpoint","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T22:28:26.78737701-05:00","updated_at":"2025-12-20T22:46:26.994869808-05:00","closed_at":"2025-12-20T22:46:26.994869808-05:00","close_reason":"Added GET /api/v1/campaigns/{id} (GetCampaign) returning campaign JSON scoped to active org.","labels":["backend"],"dependencies":[{"issue_id":"queryops-30m","depends_on_id":"queryops-0io","type":"blocks","created_at":"2025-12-20T22:28:46.060899966-05:00","created_by":"daemon"}]}
{"id":"queryops-3b5","title":"[Phase 1] Add Watermill dependencies to go.mod","description":"Add the required Watermill packages to go.mod:\n\n```bash\ngo get github.com/ThreeDotsLabs/watermill\ngo get github.com/ThreeDotsLabs/watermill-sql/v4\n```\n\n**Acceptance Criteria:**\n- `go build ./...` succeeds\n- `go mod tidy` shows no issues\n- Dependencies added to go.sum\n\n**Notes:**\n- watermill-sql v4 has native pgx adapter support via `sql.BeginnerFromPgxPool()`\n- Reference: https://watermill.io/pubsubs/sql/","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:41:04.838288218-05:00","updated_at":"2025-12-20T21:12:17.669541799-05:00","closed_at":"2025-12-20T21:12:17.669541799-05:00","close_reason":"Added Watermill + watermill-sql/v4 deps; go mod tidy; go build ./... and go test ./... pass."}
{"id":"queryops-3es","title":"Build project locally","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T22:05:09.402256306-05:00","updated_at":"2025-12-12T17:29:28.192266727-05:00","closed_at":"2025-12-12T17:29:28.192266727-05:00"}
{"id":"queryops-3j2","title":"Create user_credentials migration","description":"Migration to create user_credentials table for storing WebAuthn credentials. Includes credential_id, public_key, attestation_type, transports, flags, authenticator info, and timestamps.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T17:26:05.652852407-05:00","updated_at":"2025-12-12T17:32:00.881683257-05:00","closed_at":"2025-12-12T17:32:00.881683257-05:00","dependencies":[{"issue_id":"queryops-3j2","depends_on_id":"queryops-a05","type":"parent-child","created_at":"2025-12-12T17:27:23.605775168-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-4ze","title":"[Phase 5] Implement message cleanup strategy","description":"[Phase 6] Implement message cleanup strategy","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T20:45:36.763183198-05:00","updated_at":"2025-12-20T22:29:00.778996388-05:00","dependencies":[{"issue_id":"queryops-4ze","depends_on_id":"queryops-msu","type":"blocks","created_at":"2025-12-20T20:46:49.1289054-05:00","created_by":"daemon"}]}
{"id":"queryops-5k9","title":"[Phase 2] Create campaigns and campaign_targets database migration","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:28:19.259009316-05:00","updated_at":"2025-12-20T22:41:11.238447648-05:00","closed_at":"2025-12-20T22:41:11.238447648-05:00","close_reason":"Added campaigns + campaign_targets migrations (20251221041000_campaigns.{up,down}.sql) with optional name/description, counts, and status constraints.","labels":["database"]}
{"id":"queryops-6wi","title":"[Phase 5] Update operational documentation","description":"[Phase 6] Update operational documentation","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T20:46:23.627908776-05:00","updated_at":"2025-12-20T22:29:00.841248256-05:00","dependencies":[{"issue_id":"queryops-6wi","depends_on_id":"queryops-msu","type":"blocks","created_at":"2025-12-20T20:46:49.234334604-05:00","created_by":"daemon"}]}
{"id":"queryops-7a1","title":"[Phase 5] Load testing with many concurrent subscribers","description":"[Phase 6] Load testing with many concurrent subscribers","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T20:46:09.60504604-05:00","updated_at":"2025-12-20T22:29:00.820652201-05:00","dependencies":[{"issue_id":"queryops-7a1","depends_on_id":"queryops-msu","type":"blocks","created_at":"2025-12-20T20:46:49.1980036-05:00","created_by":"daemon"}]}
{"id":"queryops-7mo","title":"[Phase 2] Add tests for campaign repository","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T22:28:22.527675598-05:00","updated_at":"2025-12-21T07:44:14.673392617-05:00","closed_at":"2025-12-21T07:44:14.673392617-05:00","close_reason":"Added repository flow test (features/osquery/services/campaign_repository_test.go) covering create campaign, pending dispatch, saving results, and status/count rollups.","labels":["test"],"dependencies":[{"issue_id":"queryops-7mo","depends_on_id":"queryops-0io","type":"blocks","created_at":"2025-12-20T22:28:44.462674264-05:00","created_by":"daemon"}]}
{"id":"queryops-7xm","title":"Add passkey naming on registration","description":"Allow users to name their passkey when adding it (e.g., 'MacBook Pro', 'iPhone'). Add nickname column to user_credentials table. Show names in settings page.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T17:27:32.610778644-05:00","updated_at":"2025-12-12T19:29:55.294962907-05:00","closed_at":"2025-12-12T19:29:55.294962907-05:00","dependencies":[{"issue_id":"queryops-7xm","depends_on_id":"queryops-pux","type":"parent-child","created_at":"2025-12-12T17:27:45.191468045-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"queryops-7xm","depends_on_id":"queryops-05n","type":"blocks","created_at":"2025-12-12T17:27:52.440790599-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-8i6","title":"[Phase 1] Write integration test for pub/sub round-trip","description":"Create integration test proving Watermill pub/sub works with our PostgreSQL setup.\n\n**File:** `internal/pubsub/pubsub_test.go`\n\n**Test cases:**\n\n1. **TestPubSub_PublishAndSubscribe** - Basic round-trip\n```go\nfunc TestPubSub_PublishAndSubscribe(t *testing.T) {\n    pool := testdb.NewPool(t)\n    \n    ps, err := pubsub.New(context.Background(), pool, \u0026pubsub.Config{\n        AutoInitializeSchema: true, // For test isolation\n    })\n    require.NoError(t, err)\n    defer ps.Close()\n    \n    // Create subscriber first\n    sub, err := ps.NewSubscriber(context.Background())\n    require.NoError(t, err)\n    defer sub.Close()\n    \n    topic := \"test-topic-\" + uuid.New().String()\n    messages, err := sub.Subscribe(context.Background(), topic)\n    require.NoError(t, err)\n    \n    // Publish\n    event := pubsub.QueryResultEvent{\n        HostID:     uuid.New(),\n        QueryID:    uuid.New(),\n        Status:     \"completed\",\n        OccurredAt: time.Now(),\n    }\n    err = ps.Publisher().Publish(topic, event.ToMessage())\n    require.NoError(t, err)\n    \n    // Receive with timeout\n    select {\n    case msg := \u003c-messages:\n        require.NotNil(t, msg)\n        received, err := pubsub.ParseQueryResultEvent(msg)\n        require.NoError(t, err)\n        assert.Equal(t, event.QueryID, received.QueryID)\n        assert.Equal(t, event.Status, received.Status)\n        msg.Ack()\n    case \u003c-time.After(5 * time.Second):\n        t.Fatal(\"timeout waiting for message\")\n    }\n}\n```\n\n2. **TestPubSub_MultipleSubscribers** - Fan-out behavior\n```go\nfunc TestPubSub_MultipleSubscribers(t *testing.T) {\n    // Create 3 subscribers to same topic\n    // Publish 1 message\n    // Verify all 3 receive it\n}\n```\n\n3. **TestPubSub_TopicIsolation** - Messages don't leak between topics\n```go\nfunc TestPubSub_TopicIsolation(t *testing.T) {\n    // Subscribe to topic A\n    // Publish to topic B\n    // Verify no message received on A\n}\n```\n\n**Acceptance Criteria:**\n- All tests pass with real PostgreSQL (via testdb)\n- Tests are isolated (use unique topics)\n- Tests clean up resources properly\n- Timeout handling prevents hanging tests\n\n**Dependencies:**\n- internal/pubsub package implementation\n- testdb package working","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:41:55.312092416-05:00","updated_at":"2025-12-20T21:37:29.97935485-05:00","closed_at":"2025-12-20T21:37:29.97935485-05:00","close_reason":"Added integration tests for Watermill SQL pub/sub using testcontainers Postgres (publish/subscribe, multi-subscriber fanout, topic isolation) and implemented shared-table schema+offsets adapter to support dynamic topics.","dependencies":[{"issue_id":"queryops-8i6","depends_on_id":"queryops-e9t","type":"blocks","created_at":"2025-12-20T20:46:32.541883385-05:00","created_by":"daemon"},{"issue_id":"queryops-8i6","depends_on_id":"queryops-ltn","type":"blocks","created_at":"2025-12-20T20:46:32.575859743-05:00","created_by":"daemon"}]}
{"id":"queryops-8tj","title":"Category 1: Security \u0026 Bug Prevention","description":"Fix high priority issues including errcheck, gosec (G301, G107, G112), nilnil, and G115 (integer overflow).","status":"closed","issue_type":"task","created_at":"2025-12-17T23:00:45.086043689-05:00","updated_at":"2025-12-17T23:22:17.886181738-05:00","closed_at":"2025-12-17T23:22:17.886181738-05:00","dependencies":[{"issue_id":"queryops-8tj","depends_on_id":"queryops-hxq","type":"parent-child","created_at":"2025-12-17T23:00:52.010420999-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-8uk","title":"[Phase 5] Add metrics for pub/sub operations","description":"[Phase 6] Add metrics for pub/sub operations","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T20:45:19.794018944-05:00","updated_at":"2025-12-20T22:29:00.758804079-05:00","dependencies":[{"issue_id":"queryops-8uk","depends_on_id":"queryops-msu","type":"blocks","created_at":"2025-12-20T20:46:49.085339888-05:00","created_by":"daemon"}]}
{"id":"queryops-90d","title":"Provision DO droplet + DNS records","description":"Create Ubuntu droplet, attach domain, open 80/443/22, and verify SSH access for Kamal.","status":"closed","priority":1,"issue_type":"chore","created_at":"2025-12-12T21:10:13.614171982-05:00","updated_at":"2025-12-17T22:11:06.532048758-05:00","closed_at":"2025-12-17T22:11:06.532048758-05:00","dependencies":[{"issue_id":"queryops-90d","depends_on_id":"queryops-1ox","type":"parent-child","created_at":"2025-12-12T21:10:23.282189062-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-92q","title":"Remove stray fmt.Println from osquery Logger","description":"features/osquery/handlers.go Logger currently prints raw status log lines via fmt.Println, which pollutes stdout/logs and may leak data. Remove this debug statement.","acceptance_criteria":"No fmt.Println in Logger; behavior otherwise unchanged; go test ./... passes.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-20T16:03:23.70482437-05:00","updated_at":"2025-12-20T16:51:15.20438251-05:00","closed_at":"2025-12-20T16:51:15.20438251-05:00","close_reason":"Implemented DI-friendly osquery handlers, removed stray fmt.Println, and added httptest coverage for enroll/config/logger/distributed read+write; go test ./... passes.","dependencies":[{"issue_id":"queryops-92q","depends_on_id":"queryops-xzb","type":"discovered-from","created_at":"2025-12-20T16:03:23.707596616-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-9au","title":"[Phase 3] Extract polling logic to pollResultsLegacy method","description":"Extract the existing polling logic to a separate method for fallback scenarios.\n\n**File:** `features/osquery/handlers.go`\n\n**New method:**\n```go\n// pollResultsLegacy implements the fallback polling mechanism for HostResultsSSE.\n// Used when pub/sub is unavailable or subscription fails.\nfunc (h *Handlers) pollResultsLegacy(\n    ctx context.Context,\n    sse *datastar.ServerSentEventGenerator,\n    hostID uuid.UUID,\n    hostIDStr string,\n    initialResults []services.QueryResult,\n) {\n    ticker := time.NewTicker(time.Second)\n    defer ticker.Stop()\n\n    // Use initial results as baseline for diffing\n    last, _ := json.Marshal(initialResults)\n    \n    for {\n        select {\n        case \u003c-ctx.Done():\n            return\n        case \u003c-ticker.C:\n            results, err := h.repo.GetRecentResults(ctx, hostID)\n            if err != nil {\n                _ = sse.ConsoleError(err)\n                return\n            }\n\n            b, _ := json.Marshal(results)\n            if !bytes.Equal(b, last) {\n                last = b\n                if err := sse.PatchElementTempl(pages.HostResultsTable(hostIDStr, results)); err != nil {\n                    return\n                }\n            }\n        }\n    }\n}\n```\n\n**Usage in HostResultsSSE:**\n```go\n// If pub/sub not available, fall back to polling\nif h.pubsub == nil {\n    h.pollResultsLegacy(ctx, sse, hostID, hostIDStr, results)\n    return\n}\n\n// If subscription fails, fall back to polling\nsubscriber, err := h.pubsub.NewSubscriber(ctx)\nif err != nil {\n    slog.Error(\"failed to create subscriber, falling back to polling\", \"error\", err)\n    h.pollResultsLegacy(ctx, sse, hostID, hostIDStr, results)\n    return\n}\n```\n\n**Method signature explanation:**\n- `ctx`: Request context for cancellation\n- `sse`: SSE generator to send updates\n- `hostID`: UUID for database queries\n- `hostIDStr`: String for template rendering\n- `initialResults`: Already-fetched results to use as diff baseline\n\n**Why pass initialResults?**\n- Avoids redundant database query on fallback\n- Maintains consistent behavior (initial state already sent)\n- Diff baseline matches what client already has\n\n**Acceptance Criteria:**\n- Method extracted and compiles\n- Fallback works when pubsub is nil\n- Fallback works when subscription fails\n- No change in behavior from original polling implementation\n- Method is unexported (internal use only)\n\n**Testing:**\n```go\nfunc TestHostResultsSSE_FallbackToPolling_NilPubSub(t *testing.T) {\n    handlers := NewHandlers(mockRepo, nil, nil, nil) // No pubsub\n    // ... verify SSE connection works with polling ...\n}\n\nfunc TestHostResultsSSE_FallbackToPolling_SubscriptionError(t *testing.T) {\n    // Mock pubsub that returns error on NewSubscriber\n    // Verify fallback to polling\n}\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:43:45.193418875-05:00","updated_at":"2025-12-20T21:45:16.504898691-05:00","closed_at":"2025-12-20T21:45:16.504898691-05:00","close_reason":"Extracted polling SSE loop into Handlers.pollResultsLegacy and updated HostResultsSSE to send initial snapshot then fallback to polling helper.","dependencies":[{"issue_id":"queryops-9au","depends_on_id":"queryops-paz","type":"blocks","created_at":"2025-12-20T20:46:40.767917266-05:00","created_by":"daemon"}]}
{"id":"queryops-9ea","title":"Harden index template against nil org when showing enroll secret","description":"Index template renders enroll secret block when enrollSecret != \"\", but interpolates org.Name inside that block.\n\nCurrently the handler only sets enrollSecret when org != nil, but the template is brittle if future logic changes.\n\nProposed fix: guard on (org != nil \u0026\u0026 enrollSecret != \"\").\n\nTouch points: features/index/pages/index.templ","status":"closed","priority":3,"issue_type":"bug","created_at":"2025-12-19T14:29:20.075862745-05:00","updated_at":"2025-12-19T14:39:06.100519576-05:00","closed_at":"2025-12-19T14:39:06.100519576-05:00","close_reason":"Closed","labels":["severity:low"]}
{"id":"queryops-9pe","title":"Add navigation link to account settings","description":"Update navigation.templ to include link to /account settings page. Show in navbar when user is logged in.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T17:27:40.74951122-05:00","updated_at":"2025-12-12T19:29:55.321869075-05:00","closed_at":"2025-12-12T19:29:55.321869075-05:00","dependencies":[{"issue_id":"queryops-9pe","depends_on_id":"queryops-pux","type":"parent-child","created_at":"2025-12-12T17:27:45.21457061-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"queryops-9pe","depends_on_id":"queryops-05n","type":"blocks","created_at":"2025-12-12T17:27:52.46796728-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-9yw","title":"[Phase 3] Implement POST /api/v1/queries/run endpoint (create campaign)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:28:25.698918692-05:00","updated_at":"2025-12-20T22:46:26.153058836-05:00","closed_at":"2025-12-20T22:46:26.153058836-05:00","close_reason":"Added POST /api/v1/queries/run (CreateCampaign) to create campaign + targets and return campaign_id + target_count.","labels":["backend"],"dependencies":[{"issue_id":"queryops-9yw","depends_on_id":"queryops-0io","type":"blocks","created_at":"2025-12-20T22:28:46.038087592-05:00","created_by":"daemon"}]}
{"id":"queryops-a05","title":"Passkey Authentication - Phase 1","description":"Add passkey (WebAuthn) support for existing users. Users can add passkeys to their account and use them to log in. Includes: database migration for credentials table, WebAuthn service, passkey handlers, and login page updates.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-12T17:25:57.294516684-05:00","updated_at":"2025-12-12T17:37:57.531422199-05:00","closed_at":"2025-12-12T17:37:57.531422199-05:00"}
{"id":"queryops-a4f","title":"Explore app endpoints and pages","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-11T22:06:45.930944542-05:00","updated_at":"2025-12-12T17:29:28.194294851-05:00","closed_at":"2025-12-12T17:29:28.194294851-05:00"}
{"id":"queryops-abg","title":"[Phase 3] Add API route registration and tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T22:28:28.995103995-05:00","updated_at":"2025-12-20T22:46:29.173467918-05:00","closed_at":"2025-12-20T22:46:29.173467918-05:00","close_reason":"Registered /api/v1 campaign routes in features/osquery/routes.go under protected routes.","labels":["backend"],"dependencies":[{"issue_id":"queryops-abg","depends_on_id":"queryops-9yw","type":"blocks","created_at":"2025-12-20T22:28:46.104791441-05:00","created_by":"daemon"}]}
{"id":"queryops-ap3","title":"Prevent cross-org host takeover via enroll upsert","description":"Enrollment upserts on host_identifier and updates organization_id + node_key.\n\nScenario: host identifiers are often guessable; anyone with any valid org enroll secret can re-enroll an existing host_identifier and move it into their org (rotating node_key).\n\nFix options: (1) Make host_identifier unique per org: UNIQUE(organization_id, host_identifier) and upsert on that; or (2) keep global uniqueness and reject enrollment if the existing host belongs to a different org.\n\nTouch points: migrations/sql/*hosts*.sql, features/osquery/services/host_repository.go Enroll().","status":"closed","issue_type":"bug","created_at":"2025-12-19T14:29:00.050126952-05:00","updated_at":"2025-12-19T14:36:09.759307498-05:00","closed_at":"2025-12-19T14:36:09.759307498-05:00","close_reason":"Closed","labels":["severity:high"]}
{"id":"queryops-bex","title":"Avoid confusing import shadowing in navigation template","description":"features/common/components/navigation.templ imports organization/components as \"components\" inside package \"components\".\n\nImpact: readability hazard; easy to confuse local package vs imported package.\n\nProposed fix: alias import (e.g., orgcomponents) and update usages.\n\nTouch points: features/common/components/navigation.templ","status":"closed","priority":4,"issue_type":"chore","created_at":"2025-12-19T14:29:23.412063269-05:00","updated_at":"2025-12-19T14:42:58.825527151-05:00","closed_at":"2025-12-19T14:42:58.825527151-05:00","close_reason":"Closed","labels":["severity:low"]}
{"id":"queryops-bgk","title":"Use golang:1.25.5-trixie for builds","description":"Switch Dockerfile build stage to golang:1.25.5-trixie to align with glibc Debian Trixie base.","status":"closed","priority":1,"issue_type":"chore","created_at":"2025-12-12T21:53:53.23850147-05:00","updated_at":"2025-12-12T21:55:01.85641462-05:00","closed_at":"2025-12-12T21:55:01.85641462-05:00","dependencies":[{"issue_id":"queryops-bgk","depends_on_id":"queryops-1ox","type":"parent-child","created_at":"2025-12-12T21:53:57.925105809-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-bro","title":"Add db package and migrations","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T22:39:42.973473092-05:00","updated_at":"2025-12-12T17:29:28.190126321-05:00","closed_at":"2025-12-12T17:29:28.190126321-05:00"}
{"id":"queryops-brx","title":"[Phase 4] Implement GET /api/v1/campaigns/{id}/results SSE endpoint","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:28:33.081604732-05:00","updated_at":"2025-12-20T22:46:30.086111489-05:00","closed_at":"2025-12-20T22:46:30.086111489-05:00","close_reason":"Implemented GET /api/v1/campaigns/{id}/results SSE endpoint using Watermill topic campaign:{id} with polling fallback; patches Datastar signals (campaign + targets).","labels":["backend"],"dependencies":[{"issue_id":"queryops-brx","depends_on_id":"queryops-0qo","type":"blocks","created_at":"2025-12-20T22:28:47.135460316-05:00","created_by":"daemon"}]}
{"id":"queryops-chv","title":"[Phase 1] Implement Watermill slog logger adapter","description":"Create an adapter to bridge Watermill's LoggerAdapter interface with Go's slog package.\n\n**File:** `internal/pubsub/logger.go`\n\n**Interface to implement:**\n```go\ntype LoggerAdapter interface {\n    Error(msg string, err error, fields LogFields)\n    Info(msg string, fields LogFields)\n    Debug(msg string, fields LogFields)\n    Trace(msg string, fields LogFields)\n    With(fields LogFields) LoggerAdapter\n}\n```\n\n**Implementation details:**\n- `Trace` maps to `slog.Debug` (slog has no trace level)\n- `LogFields` (map[string]any) converts to slog attrs\n- `With` returns new adapter with merged fields\n- Error method includes error as slog attr\n\n**Example usage:**\n```go\nlogger := pubsub.NewSlogAdapter(slog.Default())\npublisher, err := sql.NewPublisher(beginner, config, logger)\n```\n\n**Acceptance Criteria:**\n- All LoggerAdapter methods implemented\n- Works with Watermill publisher/subscriber\n- Log output matches project slog format\n- Unit tests for adapter\n\n**Reference:** Similar pattern in background/river.go uses slog","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:41:23.231617816-05:00","updated_at":"2025-12-20T21:16:43.36120377-05:00","closed_at":"2025-12-20T21:16:43.36120377-05:00","close_reason":"Created internal/pubsub package (pubsub.go, events.go, logger.go) and added logger adapter unit tests; go test ./... passes.","dependencies":[{"issue_id":"queryops-chv","depends_on_id":"queryops-3b5","type":"blocks","created_at":"2025-12-20T20:46:32.370294871-05:00","created_by":"daemon"}]}
{"id":"queryops-cjt","title":"Add GitHub Actions workflow to run tests on PR","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T16:58:44.508961558-05:00","updated_at":"2025-12-20T16:59:16.628114821-05:00","closed_at":"2025-12-20T16:59:16.628114821-05:00","close_reason":"Added GitHub Actions workflow .github/workflows/tests.yml to run go tool task test:all on pull_request using actions/checkout@v5 and actions/setup-go@v6 (go-version-file)."}
{"id":"queryops-cp4","title":"Add Taskfile tasks for unit + integration tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T16:54:17.138616811-05:00","updated_at":"2025-12-20T16:54:42.628264027-05:00","closed_at":"2025-12-20T16:54:42.628264027-05:00","close_reason":"Added Taskfile tasks test, test:integration, and test:all for running go test ./..., the Testcontainers suite, and both together."}
{"id":"queryops-d4s","title":"Add Testcontainers Postgres integration test harness","description":"Introduce integration testing for Postgres using Testcontainers for Go (Go 1.25, Postgres 18.x, pgx v5). Provide a reusable helper that spins up an ephemeral Postgres container, runs app + River migrations, exposes a pgxpool, and cleans up via t.Cleanup.","design":"Use testcontainers-go modules/postgres with image postgres:18.1-bookworm. Wait for readiness with wait.ForListeningPort(5432/tcp) + wait.ForLog('database system is ready to accept connections' occurrence=2). Build DSN using container.Host + container.MappedPort (no hardcoded 5432). Connect via pgxpool with sslmode=disable; call Ping. Apply migrations via migrations.Up(dsn) (golang-migrate with embedded iofs). Apply River migrations via rivermigrate.New(riverpgxv5.New(pool)). Provide sample SELECT 1 test. Consider gating integration tests behind build tags or env checks to avoid failures when Docker unavailable.","acceptance_criteria":"Helper exists and is used by at least one integration test; migrations applied; go test ./... passes in envs with Docker; tests skip gracefully when Docker unavailable.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-20T16:16:25.893036748-05:00","updated_at":"2025-12-20T16:53:03.956716573-05:00","closed_at":"2025-12-20T16:53:03.956716573-05:00","close_reason":"Implemented Testcontainers Postgres integration harness (migrations + River), optional reuse mode with per-test cloned DBs, and documented usage; integration tests skip when Docker unavailable."}
{"id":"queryops-d4s.1","title":"Add testdb helper using Testcontainers Postgres","description":"Create a reusable SetupTestDB(t) helper that starts postgres:18.1-bookworm via testcontainers-go modules/postgres, returns a pgxpool, and registers cleanup with t.Cleanup.","design":"Package: internal/testdb or testing/testdb (pick one and document). Struct TestDB { Container *postgres.PostgresContainer; Pool *pgxpool.Pool; DSN/Host/Port/User/Password/Database }. SetupTestDB: start container w/ wait strategy, discover host+mapped port, build DSN with sslmode=disable, create pgxpool, Ping. On container start failure (Docker missing), t.Skipf. Ensure pool.Close and container.Terminate via t.Cleanup.","acceptance_criteria":"Helper compiles and can be used in tests; no hardcoded ports; lifecycle handled via t.Cleanup.","notes":"Implemented internal/testdb SetupTestDB using postgres:18.1-bookworm, dynamic mapped port DSN, pgxpool Ping, and t.Cleanup lifecycle.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T16:16:35.817923198-05:00","updated_at":"2025-12-20T16:20:27.576989352-05:00","closed_at":"2025-12-20T16:20:27.576992266-05:00","dependencies":[{"issue_id":"queryops-d4s.1","depends_on_id":"queryops-d4s","type":"parent-child","created_at":"2025-12-20T16:16:35.825486475-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-d4s.10","title":"Enable parallel tests with reused container","description":"Allow QUERYOPS_TESTDB_REUSE mode to support parallel tests by creating a per-test database cloned from the migrated snapshot template, instead of restoring a shared database.","design":"Keep container reuse by name. Ensure snapshot template DB exists once (serialized). For each SetupTestDB call: create dbName=test_\u003cuuid\u003e, CREATE DATABASE dbName WITH TEMPLATE snapshotName OWNER test, connect pgxpool to that DB, and t.Cleanup drop it (DROP DATABASE ... WITH (FORCE)). Remove global reuse lock so tests can run concurrently.","acceptance_criteria":"With QUERYOPS_TESTDB_REUSE=1, ?   \tgithub.com/cavenine/queryops/background\t[no test files]\n?   \tgithub.com/cavenine/queryops/cmd\t[no test files]\n?   \tgithub.com/cavenine/queryops/cmd/web\t[no test files]\n?   \tgithub.com/cavenine/queryops/cmd/web/build\t[no test files]\n?   \tgithub.com/cavenine/queryops/cmd/web/downloader\t[no test files]\n?   \tgithub.com/cavenine/queryops/config\t[no test files]\n?   \tgithub.com/cavenine/queryops/db\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/account\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/account/pages\t[no test files]\nok  \tgithub.com/cavenine/queryops/features/auth\t0.006s\n?   \tgithub.com/cavenine/queryops/features/auth/pages\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/auth/services\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/common/components\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/common/components/aspectratio\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/common/components/button\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/common/components/card\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/common/components/dialog\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/common/components/icon\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/common/layouts\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/counter\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/counter/pages\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/index\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/index/components\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/index/pages\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/index/services\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/monitor\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/monitor/pages\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/organization\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/organization/components\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/organization/pages\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/organization/services\t[no test files]\nok  \tgithub.com/cavenine/queryops/features/osquery\t0.003s\n?   \tgithub.com/cavenine/queryops/features/osquery/pages\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/osquery/services\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/reverse\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/reverse/pages\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/sortable\t[no test files]\n?   \tgithub.com/cavenine/queryops/features/sortable/pages\t[no test files]\nok  \tgithub.com/cavenine/queryops/internal/antibot\t0.003s\nok  \tgithub.com/cavenine/queryops/internal/testdb\t1.712s\n?   \tgithub.com/cavenine/queryops/migrations\t[no test files]\n?   \tgithub.com/cavenine/queryops/router\t[no test files]\n?   \tgithub.com/cavenine/queryops/utils\t[no test files]\n?   \tgithub.com/cavenine/queryops/web/resources\t[no test files] works; parallel subtests in internal/testdb pass; no cross-test data leaks.","notes":"Reuse mode now supports parallel tests: snapshot init is serialized, but each SetupTestDB call clones a unique DB from the migrated template and drops it at cleanup. Added parallel subtest to validate.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T16:35:42.703131212-05:00","updated_at":"2025-12-20T16:38:26.991941693-05:00","closed_at":"2025-12-20T16:38:26.991944829-05:00","dependencies":[{"issue_id":"queryops-d4s.10","depends_on_id":"queryops-d4s","type":"parent-child","created_at":"2025-12-20T16:35:42.703937324-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-d4s.11","title":"Add tests for reuse-mode isolation and cleanup","description":"Add integration tests that exercise QUERYOPS_TESTDB_REUSE behavior: per-test DB isolation via template cloning, and database drop on cleanup.","design":"In internal/testdb/testdb_test.go add tests that are skipped unless reuseEnabled(). 1) Create DB A, create a temp table, then create DB B and assert the temp table does not exist (to_regclass). 2) Use a subtest to create a DB and capture its name, then after subtest returns query pg_database from admin connection to ensure DB was dropped.","acceptance_criteria":"QUERYOPS_TESTDB_REUSE=1 go test ./internal/testdb passes and validates isolation; go test ./... passes by default.","notes":"Added reuse-mode tests: isolation between cloned DBs (temp table not shared) and DB drop on cleanup (pg_database check). All tests skip unless QUERYOPS_TESTDB_REUSE=1.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T16:40:31.960460547-05:00","updated_at":"2025-12-20T16:41:13.392056638-05:00","closed_at":"2025-12-20T16:41:13.392059584-05:00","dependencies":[{"issue_id":"queryops-d4s.11","depends_on_id":"queryops-d4s","type":"parent-child","created_at":"2025-12-20T16:40:31.969151014-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-d4s.2","title":"Run app migrations inside test container","description":"Ensure SetupTestDB applies application migrations to the container so integration tests run against real schema.","design":"Reuse migrations.Up(dsn) (golang-migrate + embedded iofs). Ensure DSN uses postgres:// scheme and sslmode=disable. Fail test if migrations fail.","acceptance_criteria":"After SetupTestDB, schema_migrations exists and latest migration applied; tests can query app tables.","notes":"SetupTestDB now runs migrations.Up(dsn); added migrations/pgxstdlib.go to register sql driver for golang-migrate.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T16:16:39.812004639-05:00","updated_at":"2025-12-20T16:20:28.086041668-05:00","closed_at":"2025-12-20T16:20:28.086045062-05:00","dependencies":[{"issue_id":"queryops-d4s.2","depends_on_id":"queryops-d4s","type":"parent-child","created_at":"2025-12-20T16:16:39.819494666-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-d4s.3","title":"Run River migrations inside test container","description":"Ensure SetupTestDB also applies River migrations to match production boot.","design":"Call rivermigrate.New(riverpgxv5.New(pool), nil) and migrator.Migrate(ctx, DirectionUp, nil).","acceptance_criteria":"River tables exist after SetupTestDB; no errors running migrator.","notes":"SetupTestDB applies River migrations via rivermigrate + riverpgxv5.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T16:16:42.337002253-05:00","updated_at":"2025-12-20T16:20:28.474508452-05:00","closed_at":"2025-12-20T16:20:28.474511639-05:00","dependencies":[{"issue_id":"queryops-d4s.3","depends_on_id":"queryops-d4s","type":"parent-child","created_at":"2025-12-20T16:16:42.345133229-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-d4s.4","title":"Add sample integration test using SetupTestDB","description":"Add at least one integration test demonstrating the helper (e.g., SELECT 1) and verifying container + pool work.","design":"Add a _test.go file that calls SetupTestDB and runs a simple query. Keep it minimal and table-driven if multiple cases.","acceptance_criteria":"go test (with Docker) runs sample test successfully.","notes":"Added internal/testdb/testdb_test.go demonstrating SELECT 1 against the container DB.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T16:16:45.039071304-05:00","updated_at":"2025-12-20T16:20:29.109247854-05:00","closed_at":"2025-12-20T16:20:29.109251202-05:00","dependencies":[{"issue_id":"queryops-d4s.4","depends_on_id":"queryops-d4s","type":"parent-child","created_at":"2025-12-20T16:16:45.046834556-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-d4s.5","title":"Decide and implement integration test gating","description":"Prevent CI/dev environments without Docker from failing go test ./... due to integration tests.","design":"Options: (A) build tags (//go:build integration) for container-based tests; (B) runtime skip when container startup fails (t.Skipf). Prefer runtime skip for minimal friction, optionally add build tag if CI policy requires.","acceptance_criteria":"In env without Docker, tests skip cleanly; in env with Docker, integration tests execute.","notes":"Gating implemented by t.Skipf when container startup fails (Docker unavailable).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T16:16:48.241723766-05:00","updated_at":"2025-12-20T16:20:29.520599123-05:00","closed_at":"2025-12-20T16:20:29.520603464-05:00","dependencies":[{"issue_id":"queryops-d4s.5","depends_on_id":"queryops-d4s","type":"parent-child","created_at":"2025-12-20T16:16:48.249828708-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-d4s.6","title":"Add testcontainers-go dependency to go.mod","description":"Vendor in Testcontainers for Go and postgres module dependencies for integration tests.","design":"Add github.com/testcontainers/testcontainers-go and github.com/testcontainers/testcontainers-go/modules/postgres. Keep versions consistent and minimal.","acceptance_criteria":"go mod tidy produces clean go.mod/go.sum; build and tests succeed.","notes":"Added testcontainers-go v0.40.0 + modules/postgres; ran go mod tidy.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T16:16:51.373821397-05:00","updated_at":"2025-12-20T16:20:27.045070435-05:00","closed_at":"2025-12-20T16:20:27.045073284-05:00","dependencies":[{"issue_id":"queryops-d4s.6","depends_on_id":"queryops-d4s","type":"parent-child","created_at":"2025-12-20T16:16:51.381278175-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-d4s.7","title":"Document integration test usage","description":"Add brief docs on how to run container-backed integration tests locally.","design":"Update existing docs or QUICK_REFERENCE with commands (e.g. go test ./... or go test -run TestName). Mention Docker required and Postgres image postgres:18.1-bookworm.","acceptance_criteria":"Docs mention how to run and what prerequisites exist.","notes":"Reuse mode implemented; docs can mention QUERYOPS_TESTDB_REUSE=1 once requested.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-20T16:16:54.088209531-05:00","updated_at":"2025-12-20T16:52:56.145748592-05:00","closed_at":"2025-12-20T16:52:56.145748592-05:00","close_reason":"Documented how to run Testcontainers-backed integration tests (Docker prerequisite, postgres:18.1-bookworm, and optional QUERYOPS_TESTDB_REUSE mode) in docs/QUICK_REFERENCE.md.","dependencies":[{"issue_id":"queryops-d4s.7","depends_on_id":"queryops-d4s","type":"parent-child","created_at":"2025-12-20T16:16:54.094773227-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-d4s.8","title":"Add opt-in Testcontainers reuse mode","description":"Allow reusing the Postgres testcontainer between go test runs (experimental) when enabled via env var, while still dropping the database used by a test to keep isolation.","design":"Add QUERYOPS_TESTDB_REUSE=1 opt-in. When enabled, start container with testcontainers.WithReuseByName(\u003cfixed-name\u003e) so it persists across runs; do not Terminate in t.Cleanup. For isolation, create a unique database per SetupTestDB call (e.g. test_\u003cuuid\u003e), connect pool to it, run migrations + River migrations, and in t.Cleanup close pool then DROP DATABASE ... WITH (FORCE).","acceptance_criteria":"With reuse off, behavior unchanged (container terminated). With reuse on, container persists across runs but each test DB is created and dropped; go test ./... passes.","notes":"Added QUERYOPS_TESTDB_REUSE opt-in: reuses container by name and creates/drops a unique per-test database (migrations + River applied) while keeping container alive across runs.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T16:27:33.697526581-05:00","updated_at":"2025-12-20T16:28:59.852741504-05:00","closed_at":"2025-12-20T16:28:59.852744489-05:00","dependencies":[{"issue_id":"queryops-d4s.8","depends_on_id":"queryops-d4s","type":"parent-child","created_at":"2025-12-20T16:27:33.70485303-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-d4s.9","title":"Add snapshot/restore to reused test DB","description":"Speed up QUERYOPS_TESTDB_REUSE mode by snapshotting the migrated database once and restoring it for each test instead of re-running migrations.","design":"When reuse enabled: ensure container has a template snapshot DB (default name migrated_template). On first run: create base DB, run app + River migrations, create snapshot via container.Snapshot(ctx). For each test: container.Restore(ctx) to reset DB state quickly, then hand out a pool to the restored DB. Keep per-test cleanup minimal (close pool only).","acceptance_criteria":"With QUERYOPS_TESTDB_REUSE=1, first run creates snapshot; subsequent tests restore without rerunning migrations; go test ./... passes.","notes":"Implemented snapshot+restore in QUERYOPS_TESTDB_REUSE mode: creates a migrated template snapshot once (after app + River migrations) and restores it before each test; added connection-drain retry for snapshot creation.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T16:29:46.610511363-05:00","updated_at":"2025-12-20T16:34:11.55825259-05:00","closed_at":"2025-12-20T16:34:11.558255623-05:00","dependencies":[{"issue_id":"queryops-d4s.9","depends_on_id":"queryops-d4s","type":"parent-child","created_at":"2025-12-20T16:29:46.617425377-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-d6b","title":"Category 2: Logic \u0026 Correctness","description":"Address extensive variable shadowing (shadow) throughout the codebase to prevent subtle logic errors.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T23:00:45.096982429-05:00","updated_at":"2025-12-17T23:22:48.732843568-05:00","closed_at":"2025-12-17T23:22:48.732843568-05:00","dependencies":[{"issue_id":"queryops-d6b","depends_on_id":"queryops-hxq","type":"parent-child","created_at":"2025-12-17T23:00:56.554191253-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"queryops-d6b","depends_on_id":"queryops-8tj","type":"blocks","created_at":"2025-12-17T23:00:56.592521247-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-d79","title":"Create credential repository","description":"New credential_repository.go with CRUD operations: Create, GetByUserID, GetByCredentialID, UpdateSignCount, Delete. Maps between webauthn.Credential and database rows.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T17:26:14.114616743-05:00","updated_at":"2025-12-12T17:33:31.498781261-05:00","closed_at":"2025-12-12T17:33:31.498781261-05:00","dependencies":[{"issue_id":"queryops-d79","depends_on_id":"queryops-3j2","type":"blocks","created_at":"2025-12-12T17:27:07.85260157-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"queryops-d79","depends_on_id":"queryops-nck","type":"blocks","created_at":"2025-12-12T17:27:07.863720483-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"queryops-d79","depends_on_id":"queryops-a05","type":"parent-child","created_at":"2025-12-12T17:27:23.6446522-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-daa","title":"Add antibot checks to register form","description":"Add honeypot + JS token + timing antibot checks to /register (JS required, hard-block). Includes server-side validator, DataStar-compatible token injection JS, CSS utility, tests, and docs.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-13T21:27:05.828390583-05:00","updated_at":"2025-12-13T21:33:49.511583808-05:00","closed_at":"2025-12-13T21:33:49.511583808-05:00"}
{"id":"queryops-dls","title":"[Phase 6] Auto-generate campaign name/description if empty","description":"If campaign name/description are omitted, generate defaults (e.g., summarize SQL) using an AI helper in a later phase. No TODO comments in code; track in beads.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:36:57.866180634-05:00","updated_at":"2025-12-20T22:36:57.866180634-05:00","labels":["backend"],"dependencies":[{"issue_id":"queryops-dls","depends_on_id":"queryops-5k9","type":"blocks","created_at":"2025-12-20T22:41:13.253791535-05:00","created_by":"daemon"}]}
{"id":"queryops-dr2","title":"[Phase 3] Refactor HostResultsSSE to use pub/sub subscription","description":"Refactor the HostResultsSSE handler to subscribe to query result events instead of polling.\n\n**File:** `features/osquery/handlers.go`\n\n**Current implementation (polling):**\n```go\nfunc (h *Handlers) HostResultsSSE(w http.ResponseWriter, r *http.Request) {\n    // ... validation ...\n    \n    sse := datastar.NewSSE(w, r)\n    ticker := time.NewTicker(time.Second)\n    defer ticker.Stop()\n\n    var last []byte\n    for {\n        results, err := h.repo.GetRecentResults(ctx, hostID)\n        // ... error handling ...\n        \n        b, _ := json.Marshal(results)\n        if !bytes.Equal(b, last) {\n            last = b\n            sse.PatchElementTempl(pages.HostResultsTable(hostIDStr, results))\n        }\n\n        select {\n        case \u003c-ctx.Done():\n            return\n        case \u003c-ticker.C:\n        }\n    }\n}\n```\n\n**New implementation (subscription):**\n```go\nfunc (h *Handlers) HostResultsSSE(w http.ResponseWriter, r *http.Request) {\n    hostIDStr := chi.URLParam(r, \"id\")\n    hostID, err := uuid.Parse(hostIDStr)\n    if err != nil {\n        http.Error(w, \"invalid host id\", http.StatusBadRequest)\n        return\n    }\n\n    // ... organization validation (unchanged) ...\n\n    ctx := r.Context()\n    sse := datastar.NewSSE(w, r)\n\n    // 1. Send initial state immediately\n    results, err := h.repo.GetRecentResults(ctx, hostID)\n    if err != nil {\n        _ = sse.ConsoleError(err)\n        return\n    }\n    if err := sse.PatchElementTempl(pages.HostResultsTable(hostIDStr, results)); err != nil {\n        return\n    }\n\n    // 2. If pub/sub not available, fall back to polling\n    if h.pubsub == nil {\n        h.pollResultsLegacy(ctx, sse, hostID, hostIDStr, results)\n        return\n    }\n\n    // 3. Create subscriber for this connection\n    subscriber, err := h.pubsub.NewSubscriber(ctx)\n    if err != nil {\n        slog.Error(\"failed to create subscriber, falling back to polling\", \"error\", err)\n        h.pollResultsLegacy(ctx, sse, hostID, hostIDStr, results)\n        return\n    }\n    defer subscriber.Close()\n\n    // 4. Subscribe to this host's topic\n    topic := pubsub.TopicQueryResults(hostID)\n    messages, err := subscriber.Subscribe(ctx, topic)\n    if err != nil {\n        slog.Error(\"failed to subscribe, falling back to polling\", \"error\", err)\n        h.pollResultsLegacy(ctx, sse, hostID, hostIDStr, results)\n        return\n    }\n\n    // 5. Stream updates as events arrive\n    for {\n        select {\n        case \u003c-ctx.Done():\n            return\n            \n        case msg := \u003c-messages:\n            if msg == nil {\n                // Channel closed, subscriber shutting down\n                return\n            }\n            \n            event, err := pubsub.ParseQueryResultEvent(msg)\n            if err != nil {\n                slog.Error(\"failed to parse event\", \"error\", err)\n                msg.Nack()\n                continue\n            }\n            \n            slog.Debug(\"received query result event\",\n                \"host_id\", event.HostID,\n                \"query_id\", event.QueryID,\n                \"status\", event.Status,\n            )\n            \n            // Fetch fresh results to display full list\n            results, err := h.repo.GetRecentResults(ctx, hostID)\n            if err != nil {\n                slog.Error(\"failed to get results after event\", \"error\", err)\n                msg.Nack()\n                continue\n            }\n            \n            if err := sse.PatchElementTempl(pages.HostResultsTable(hostIDStr, results)); err != nil {\n                msg.Nack()\n                return // SSE connection closed\n            }\n            \n            msg.Ack()\n        }\n    }\n}\n```\n\n**Design decisions:**\n\n1. **Initial load + subscription:** Send current state immediately, then subscribe for updates. No gap in data.\n\n2. **Re-fetch on event:** On receiving event, we re-fetch full results rather than trying to merge event data. Simpler, no race conditions, handles out-of-order events.\n\n3. **Per-connection subscriber:** Each SSE connection creates its own subscriber. Simple, no shared state, clean lifecycle.\n\n4. **Graceful fallback:** If subscription fails at any point, fall back to polling. User experience unchanged.\n\n5. **Message ack/nack:** Ack on successful SSE send, Nack on error. Watermill will redeliver nacked messages.\n\n**Acceptance Criteria:**\n- SSE receives updates within ~100ms of event publish\n- Multiple browsers can subscribe to same host\n- Falls back to polling if pubsub unavailable\n- Connection properly cleans up subscriber on close\n- No goroutine leaks\n\n**Performance note:**\nWatermill SQL subscriber polls the database at PollInterval (default 1s). For lower latency, we configure 100ms in PubSub.NewSubscriber(). This is a tradeoff between latency and DB load.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:43:31.529033606-05:00","updated_at":"2025-12-20T21:45:25.876512145-05:00","closed_at":"2025-12-20T21:45:25.876512145-05:00","close_reason":"Refactored HostResultsSSE to: send initial results immediately; subscribe to Watermill topic query_results:{host_id} when pubsub available; refresh results on each event; ack/nack appropriately; fall back to pollResultsLegacy on pubsub/subscription failure.","dependencies":[{"issue_id":"queryops-dr2","depends_on_id":"queryops-9au","type":"blocks","created_at":"2025-12-20T20:46:40.811730143-05:00","created_by":"daemon"},{"issue_id":"queryops-dr2","depends_on_id":"queryops-se3","type":"blocks","created_at":"2025-12-20T20:46:40.84789328-05:00","created_by":"daemon"},{"issue_id":"queryops-dr2","depends_on_id":"queryops-zyu","type":"blocks","created_at":"2025-12-20T20:46:40.882527296-05:00","created_by":"daemon"}]}
{"id":"queryops-duv","title":"[Phase 5] Create campaign results SSE component (Datastar)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T22:28:39.569024252-05:00","updated_at":"2025-12-21T07:50:12.169924223-05:00","closed_at":"2025-12-21T07:50:12.169924223-05:00","close_reason":"Implemented CampaignResultsTable templ component and switched CampaignResultsSSE to stream datastar-patch-elements updates; added /campaigns/{id}/results SSE route.","labels":["frontend"],"dependencies":[{"issue_id":"queryops-duv","depends_on_id":"queryops-brx","type":"blocks","created_at":"2025-12-20T22:28:48.240419943-05:00","created_by":"daemon"}]}
{"id":"queryops-e9t","title":"[Phase 1] Create internal/pubsub package with core types","description":"Create the foundational pub/sub package structure:\n\n**Directory:** `internal/pubsub/`\n\n**Files to create:**\n\n1. **pubsub.go** - Main PubSub struct and factory\n   ```go\n   type PubSub struct {\n       pool      *pgxpool.Pool\n       publisher *sql.Publisher\n       logger    watermill.LoggerAdapter\n   }\n   \n   type Config struct {\n       AutoInitializeSchema bool\n   }\n   \n   func New(ctx context.Context, pool *pgxpool.Pool, cfg *Config) (*PubSub, error)\n   func (ps *PubSub) Publisher() *sql.Publisher\n   func (ps *PubSub) NewSubscriber(ctx context.Context) (*sql.Subscriber, error)\n   func (ps *PubSub) Close() error\n   ```\n\n2. **events.go** - Event type definitions\n   ```go\n   func TopicQueryResults(hostID uuid.UUID) string\n   \n   type QueryResultEvent struct {\n       HostID     uuid.UUID\n       QueryID    uuid.UUID\n       Status     string\n       OccurredAt time.Time\n       Error      *string\n   }\n   \n   func (e QueryResultEvent) ToMessage() *message.Message\n   func ParseQueryResultEvent(msg *message.Message) (QueryResultEvent, error)\n   ```\n\n3. **logger.go** - Watermill slog adapter\n   ```go\n   type SlogAdapter struct {...}\n   func NewSlogAdapter(logger *slog.Logger) *SlogAdapter\n   // Implement watermill.LoggerAdapter interface\n   ```\n\n**Acceptance Criteria:**\n- Package compiles without errors\n- Types exported and documented\n- Follows project conventions (error wrapping, logging)\n\n**Dependencies:** Requires watermill deps in go.mod","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:41:14.22691452-05:00","updated_at":"2025-12-20T21:16:43.354938449-05:00","closed_at":"2025-12-20T21:16:43.354938449-05:00","close_reason":"Created internal/pubsub package (pubsub.go, events.go, logger.go) and added logger adapter unit tests; go test ./... passes.","dependencies":[{"issue_id":"queryops-e9t","depends_on_id":"queryops-3b5","type":"blocks","created_at":"2025-12-20T20:46:32.330701745-05:00","created_by":"daemon"}]}
{"id":"queryops-ehk","title":"Add Kamal config for web/worker/postgres","description":"Create config/deploy.yml for single-VM deploy: web role, workers role (proxy disabled), postgres accessory, env/secrets, and proxy settings.","status":"closed","issue_type":"feature","created_at":"2025-12-12T21:10:10.299057864-05:00","updated_at":"2025-12-12T21:14:08.909458879-05:00","closed_at":"2025-12-12T21:14:08.909458879-05:00","dependencies":[{"issue_id":"queryops-ehk","depends_on_id":"queryops-1ox","type":"parent-child","created_at":"2025-12-12T21:10:21.8980389-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-en2","title":"Category 3: Code Complexity \u0026 Maintenance","description":"Refactor high cognitive complexity handlers (gocognit) and remove unused parameters (revive).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T23:00:45.107809589-05:00","updated_at":"2025-12-17T23:23:58.240146736-05:00","closed_at":"2025-12-17T23:23:58.240146736-05:00","dependencies":[{"issue_id":"queryops-en2","depends_on_id":"queryops-hxq","type":"parent-child","created_at":"2025-12-17T23:00:56.564128271-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"queryops-en2","depends_on_id":"queryops-d6b","type":"blocks","created_at":"2025-12-17T23:00:56.602921169-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-era","title":"Fix passkey options format for SimpleWebAuthn compatibility","description":"Return options.Response instead of full options struct to match SimpleWebAuthn expected format","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-12T17:56:59.026842473-05:00","updated_at":"2025-12-12T17:56:59.049392766-05:00","closed_at":"2025-12-12T17:56:59.049392766-05:00"}
{"id":"queryops-eu3","title":"Category 5: Style \u0026 Formatting","description":"Fix low priority issues: goimports, godot, mnd (magic numbers), perfsprint, and intrange.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-17T23:00:45.12879872-05:00","updated_at":"2025-12-19T14:33:03.976447187-05:00","closed_at":"2025-12-19T14:33:03.976447187-05:00","close_reason":"Closed","dependencies":[{"issue_id":"queryops-eu3","depends_on_id":"queryops-hxq","type":"parent-child","created_at":"2025-12-17T23:00:56.583283826-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"queryops-eu3","depends_on_id":"queryops-ks4","type":"blocks","created_at":"2025-12-17T23:00:56.622855491-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-ey1","title":"[Phase 6] Add campaign TTL/expiration and cleanup","description":"Add optional expires_at/ttl semantics and periodic cleanup/failover for stuck campaigns. Track separately from Watermill message cleanup.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:36:59.115904153-05:00","updated_at":"2025-12-20T22:36:59.115904153-05:00","labels":["backend"],"dependencies":[{"issue_id":"queryops-ey1","depends_on_id":"queryops-5k9","type":"blocks","created_at":"2025-12-20T22:41:13.281172152-05:00","created_by":"daemon"}]}
{"id":"queryops-f1b","title":"Fix Dockerfile for Kamal (alpine runtime)","description":"Update Dockerfile to build ./cmd binary, run 'web' by default, and use alpine runtime (not scratch) to support kamal exec/hooks.","status":"closed","issue_type":"chore","created_at":"2025-12-12T21:10:07.882086018-05:00","updated_at":"2025-12-12T21:14:03.701568202-05:00","closed_at":"2025-12-12T21:14:03.701568202-05:00","dependencies":[{"issue_id":"queryops-f1b","depends_on_id":"queryops-1ox","type":"parent-child","created_at":"2025-12-12T21:10:21.168434245-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-ghr","title":"Confirm untracked assets/rules are intended for this change","description":"Working tree includes new untracked directories/files (screenshots, rules, sgconfig.yml).\n\nImpact: potentially large/noisy diffs; may be accidental commit payload.\n\nProposed action: confirm which are intentional; exclude from commits or relocate if not.\n\nTouch points: registration_flow_screenshots/, rules/, rule-tests/, sgconfig.yml","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-19T14:29:29.907478162-05:00","updated_at":"2025-12-19T14:41:52.087783765-05:00","closed_at":"2025-12-19T14:41:52.087783765-05:00","close_reason":"Closed","labels":["severity:low"]}
{"id":"queryops-gy9","title":"Differentiate invalid enroll secret vs backend errors","description":"Enroll currently treats (err != nil) the same as (secret not found) and returns NodeInvalid.\n\nImpact: transient DB errors appear as \"invalid secret\", slowing diagnosis and causing misleading client behavior.\n\nProposed fix: distinguish not-found from unexpected errors; return 500 on unexpected errors, NodeInvalid only on not-found.\n\nTouch points: features/osquery/handlers.go Enroll(), features/organization/services/organization_repository.go GetOrganizationByEnrollSecret().","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-19T14:29:07.013855283-05:00","updated_at":"2025-12-19T14:36:09.795539505-05:00","closed_at":"2025-12-19T14:36:09.795539505-05:00","close_reason":"Closed","labels":["severity:medium"]}
{"id":"queryops-hxq","title":"Triage and fix golangci-lint failures","status":"closed","issue_type":"epic","created_at":"2025-12-17T23:00:40.505283518-05:00","updated_at":"2025-12-19T14:33:03.994326088-05:00","closed_at":"2025-12-19T14:33:03.994326088-05:00","close_reason":"Closed"}
{"id":"queryops-ixw","title":"[Phase 5] Create campaign execution page template","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T22:28:38.311887576-05:00","updated_at":"2025-12-21T07:50:10.176914101-05:00","closed_at":"2025-12-21T07:50:10.176914101-05:00","close_reason":"Added campaign UI pages: /campaigns list, /campaigns/new form, /campaigns/{id} details page rendering server-side CampaignResultsTable.","labels":["frontend"],"dependencies":[{"issue_id":"queryops-ixw","depends_on_id":"queryops-brx","type":"blocks","created_at":"2025-12-20T22:28:48.217859411-05:00","created_by":"daemon"}]}
{"id":"queryops-jgq","title":"Update login page with passkey support","description":"Modify login.templ to add 'Sign in with Passkey' button. Include SimpleWebAuthn browser library from CDN. Add inline JS to handle passkey flow: call /passkey/login/begin, invoke startAuthentication(), call /passkey/login/finish, redirect on success.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T17:26:26.908684981-05:00","updated_at":"2025-12-12T17:37:49.331239037-05:00","closed_at":"2025-12-12T17:37:49.331239037-05:00","dependencies":[{"issue_id":"queryops-jgq","depends_on_id":"queryops-vde","type":"blocks","created_at":"2025-12-12T17:27:18.706737835-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"queryops-jgq","depends_on_id":"queryops-a05","type":"parent-child","created_at":"2025-12-12T17:27:23.678027009-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-k5j","title":"[Phase 5] Add campaign history/list view","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-20T22:28:40.787581944-05:00","updated_at":"2025-12-21T07:50:32.479396403-05:00","closed_at":"2025-12-21T07:50:32.479396403-05:00","close_reason":"Implemented campaign history/list UI at /campaigns (CampaignsPage) and wired navigation Queries link to /campaigns.","labels":["frontend"],"dependencies":[{"issue_id":"queryops-k5j","depends_on_id":"queryops-ixw","type":"blocks","created_at":"2025-12-20T22:28:48.260401769-05:00","created_by":"daemon"}]}
{"id":"queryops-ks4","title":"Category 4: Project Standards","description":"Address gochecknoglobals (especially Lucide icons), gochecknoinits, and forbidigo (fmt.Printf).","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T23:00:45.118313551-05:00","updated_at":"2025-12-19T14:33:03.956220453-05:00","closed_at":"2025-12-19T14:33:03.956220453-05:00","close_reason":"Closed","dependencies":[{"issue_id":"queryops-ks4","depends_on_id":"queryops-hxq","type":"parent-child","created_at":"2025-12-17T23:00:56.573856955-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"queryops-ks4","depends_on_id":"queryops-en2","type":"blocks","created_at":"2025-12-17T23:00:56.612607086-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-lid","title":"[Phase 2] Update osquery routes to inject publisher","description":"Update the osquery route setup functions to accept and inject the publisher.\n\n**File:** `features/osquery/routes.go`\n\n**Current signatures:**\n```go\nfunc SetupRoutes(r chi.Router, pool *pgxpool.Pool, orgService enrollmentOrgLookup) {\n    // ...\n    handlers := NewHandlers(repo, orgService)\n    // ...\n}\n\nfunc SetupProtectedRoutes(r chi.Router, pool *pgxpool.Pool, orgService enrollmentOrgLookup) {\n    // ...\n    handlers := NewHandlers(repo, orgService)\n    // ...\n}\n```\n\n**Updated signatures:**\n```go\nimport (\n    \"github.com/ThreeDotsLabs/watermill/message\"\n    \"github.com/cavenine/queryops/internal/pubsub\"\n)\n\n// SetupRoutes configures public osquery agent endpoints.\n// publisher can be nil for graceful degradation.\nfunc SetupRoutes(\n    r chi.Router,\n    pool *pgxpool.Pool,\n    orgService enrollmentOrgLookup,\n    publisher message.Publisher,\n) {\n    repo := services.NewHostRepository(pool)\n    handlers := NewHandlers(repo, orgService, publisher, nil)\n    // ... routes ...\n}\n\n// SetupProtectedRoutes configures authenticated osquery UI endpoints.\n// ps can be nil for graceful degradation to polling.\nfunc SetupProtectedRoutes(\n    r chi.Router,\n    pool *pgxpool.Pool,\n    orgService enrollmentOrgLookup,\n    ps *pubsub.PubSub,\n) {\n    repo := services.NewHostRepository(pool)\n    var publisher message.Publisher\n    if ps != nil {\n        publisher = ps.Publisher()\n    }\n    handlers := NewHandlers(repo, orgService, publisher, ps)\n    // ... routes ...\n}\n```\n\n**Why different parameters?**\n- **SetupRoutes (public):** Only needs publisher for DistributedWrite. Doesn't need subscriber creation.\n- **SetupProtectedRoutes (protected):** Needs full PubSub for SSE handler subscriber creation.\n\n**Alternative: Pass PubSub to both**\n```go\nfunc SetupRoutes(r chi.Router, pool *pgxpool.Pool, orgService enrollmentOrgLookup, ps *pubsub.PubSub)\nfunc SetupProtectedRoutes(r chi.Router, pool *pgxpool.Pool, orgService enrollmentOrgLookup, ps *pubsub.PubSub)\n```\nThis is simpler but SetupRoutes would only use ps.Publisher().\n\n**Decision:** Use the alternative (pass PubSub to both) for consistency.\n\n**Updated caller in router/router.go:**\n```go\n// Current\nosqueryFeature.SetupRoutes(router, pool, orgService)\n// ...\nosqueryFeature.SetupProtectedRoutes(r, pool, orgService)\n\n// Updated\nosqueryFeature.SetupRoutes(router, pool, orgService, ps)\n// ...\nosqueryFeature.SetupProtectedRoutes(r, pool, orgService, ps)\n```\n\n**Acceptance Criteria:**\n- Both route setup functions accept PubSub parameter\n- Handlers created with publisher from PubSub\n- Nil PubSub handled gracefully\n- router.go updated to pass PubSub\n- Server starts and routes work\n\n**Dependencies:**\n- Handlers struct updated with publisher field\n- internal/pubsub package exists","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:42:52.585488758-05:00","updated_at":"2025-12-20T21:44:00.933748538-05:00","closed_at":"2025-12-20T21:44:00.933748538-05:00","close_reason":"Threaded *pubsub.PubSub through router -\u003e osquery SetupRoutes/SetupProtectedRoutes and inject publisher (ps.Publisher()) into handlers; nil ps degrades gracefully; go test ./... passes.","dependencies":[{"issue_id":"queryops-lid","depends_on_id":"queryops-paz","type":"blocks","created_at":"2025-12-20T20:46:36.912768858-05:00","created_by":"daemon"},{"issue_id":"queryops-lid","depends_on_id":"queryops-zyu","type":"blocks","created_at":"2025-12-20T20:46:36.949294293-05:00","created_by":"daemon"}]}
{"id":"queryops-ltn","title":"[Phase 1] Create database migration for Watermill tables","description":"Create migration for Watermill's PostgreSQL schema tables.\n\n**File:** `migrations/sql/YYYYMMDDHHMMSS_watermill_pubsub.up.sql`\n\n**Tables to create:**\n\n1. **watermill_messages** - Stores published messages\n```sql\nCREATE TABLE IF NOT EXISTS watermill_messages (\n    \"offset\" BIGSERIAL PRIMARY KEY,\n    \"uuid\" VARCHAR(36) NOT NULL,\n    \"created_at\" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    \"payload\" JSONB NOT NULL,\n    \"metadata\" JSONB NOT NULL,\n    \"topic\" VARCHAR(255) NOT NULL\n);\n\nCREATE INDEX IF NOT EXISTS idx_watermill_messages_topic_offset \n    ON watermill_messages (topic, \"offset\");\n```\n\n2. **watermill_offsets** - Tracks consumer group positions\n```sql\nCREATE TABLE IF NOT EXISTS watermill_offsets (\n    consumer_group VARCHAR(255) NOT NULL,\n    topic VARCHAR(255) NOT NULL,\n    offset_acked BIGINT NOT NULL,\n    last_processed_transaction_id XID8,\n    PRIMARY KEY (consumer_group, topic)\n);\n```\n\n**Down migration:** `YYYYMMDDHHMMSS_watermill_pubsub.down.sql`\n```sql\nDROP TABLE IF EXISTS watermill_offsets;\nDROP TABLE IF EXISTS watermill_messages;\n```\n\n**Acceptance Criteria:**\n- Migration runs successfully with `go tool task migrate`\n- Idempotent (can run multiple times)\n- Down migration cleanly removes tables\n- Schema matches Watermill's DefaultPostgreSQLSchema expectations\n\n**Notes:**\n- Use explicit migration rather than AutoInitializeSchema for production control\n- XID8 is PostgreSQL's transaction ID type (64-bit)\n- The \"offset\" column is quoted because OFFSET is a reserved word","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:41:33.092748112-05:00","updated_at":"2025-12-20T21:17:25.919928404-05:00","closed_at":"2025-12-20T21:17:25.919928404-05:00","close_reason":"Added Watermill schema migrations (20251221022000_watermill_pubsub.{up,down}.sql) creating watermill_messages and watermill_offsets tables.","dependencies":[{"issue_id":"queryops-ltn","depends_on_id":"queryops-3b5","type":"blocks","created_at":"2025-12-20T20:46:32.404997289-05:00","created_by":"daemon"}],"comments":[{"id":2,"issue_id":"queryops-ltn","author":"ben","text":"Note: watermill-sql v4 default PostgreSQL schema creates per-topic tables (watermill_\u003ctopic\u003e, watermill_offsets_\u003ctopic\u003e). We implemented a shared-table schema (internal/pubsub/schema.go) and updated migration 20251221022000_watermill_pubsub.up.sql accordingly.","created_at":"2025-12-21T02:37:39Z"}]}
{"id":"queryops-lww","title":"Add organization_id to Host model and repository queries","description":"Schema adds hosts.organization_id but Host model/queries do not select or scan it.\n\nImpact: cannot reliably enforce tenancy in handlers/repo; org checks become impossible or error-prone.\n\nProposed fix: add OrganizationID to services.Host; include organization_id in SELECT/Scan; add org-scoped repo methods (ListByOrganization, GetByIDAndOrg, etc.).\n\nTouch points: features/osquery/services/host_repository.go, related templates/handlers as needed.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-19T14:29:10.601400029-05:00","updated_at":"2025-12-19T14:36:12.69990635-05:00","closed_at":"2025-12-19T14:36:12.69990635-05:00","close_reason":"Closed","labels":["severity:high"]}
{"id":"queryops-meg","title":"Add passkey removal functionality","description":"DELETE /passkey/{id} endpoint to remove a passkey. Require at least one auth method remains (password or another passkey). Update settings page to call this endpoint.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T17:27:36.829186901-05:00","updated_at":"2025-12-12T19:29:55.310754379-05:00","closed_at":"2025-12-12T19:29:55.310754379-05:00","dependencies":[{"issue_id":"queryops-meg","depends_on_id":"queryops-pux","type":"parent-child","created_at":"2025-12-12T17:27:45.203765329-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"queryops-meg","depends_on_id":"queryops-05n","type":"blocks","created_at":"2025-12-12T17:27:52.454570845-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-msu","title":"[Phase 4] Create end-to-end test scenario","description":"Create a comprehensive end-to-end test that exercises the full flow.\n\n**Test scenario:**\n1. Start server with pub/sub enabled\n2. Create a test organization and host\n3. Open browser/client to host details page (SSE connection)\n4. Simulate osquery agent submitting query results\n5. Verify browser receives update via SSE\n\n**File:** `features/osquery/e2e_test.go` or manual test script\n\n**Automated test approach:**\n```go\n//go:build e2e\n\nfunc TestE2E_QueryResultsStreaming(t *testing.T) {\n    // 1. Setup: Create test server with real DB and pubsub\n    pool := testdb.NewPool(t)\n    ps, _ := pubsub.New(context.Background(), pool, nil)\n    defer ps.Close()\n    \n    // Setup router with all middleware\n    r := chi.NewRouter()\n    // ... full router setup ...\n    \n    server := httptest.NewServer(r)\n    defer server.Close()\n    \n    // 2. Create test data\n    orgID := createTestOrg(t, pool)\n    hostID := createTestHost(t, pool, orgID)\n    \n    // 3. Open SSE connection (simulating browser)\n    sseURL := server.URL + \"/hosts/\" + hostID.String() + \"/results\"\n    resp, err := http.Get(sseURL)\n    require.NoError(t, err)\n    defer resp.Body.Close()\n    \n    // Start reading SSE events in background\n    events := make(chan string, 10)\n    go func() {\n        scanner := bufio.NewScanner(resp.Body)\n        for scanner.Scan() {\n            line := scanner.Text()\n            if strings.HasPrefix(line, \"data:\") {\n                events \u003c- line\n            }\n        }\n    }()\n    \n    // 4. Wait for initial state\n    select {\n    case \u003c-events:\n        // Initial load received\n    case \u003c-time.After(2 * time.Second):\n        t.Fatal(\"timeout waiting for initial SSE data\")\n    }\n    \n    // 5. Simulate osquery agent\n    queryID := uuid.New()\n    distReq := DistributedWriteRequest{\n        NodeKey:  getHostNodeKey(t, pool, hostID),\n        Statuses: map[string]int{queryID.String(): 0},\n        Queries: map[string][]map[string]string{\n            queryID.String(): {{\"column\": \"value\"}},\n        },\n    }\n    body, _ := json.Marshal(distReq)\n    agentResp, err := http.Post(\n        server.URL+\"/osquery/distributed_write\",\n        \"application/json\",\n        bytes.NewReader(body),\n    )\n    require.NoError(t, err)\n    require.Equal(t, http.StatusOK, agentResp.StatusCode)\n    agentResp.Body.Close()\n    \n    // 6. Verify SSE receives update\n    select {\n    case data := \u003c-events:\n        assert.Contains(t, data, \"completed\")\n        assert.Contains(t, data, queryID.String())\n    case \u003c-time.After(2 * time.Second):\n        t.Fatal(\"timeout waiting for SSE update after distributed_write\")\n    }\n}\n```\n\n**Manual test script (for development):**\n```bash\n#!/bin/bash\n# e2e_test.sh\n\n# 1. Start server\ngo tool task live \u0026\nSERVER_PID=$!\nsleep 3\n\n# 2. Open SSE connection in background\ncurl -N http://localhost:8080/hosts/HOST_ID/results \u0026\nSSE_PID=$!\n\n# 3. Simulate osquery agent\ncurl -X POST http://localhost:8080/osquery/distributed_write \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"node_key\": \"...\", \"statuses\": {...}, \"queries\": {...}}'\n\n# 4. Observe SSE output (should show update)\nsleep 2\nkill $SSE_PID $SERVER_PID\n```\n\n**HTTP file for manual testing:**\nAdd to `osquery_tests.http`:\n```http\n### Test SSE with pub/sub (run this, then run distributed_write below)\nGET http://localhost:8080/hosts/{{hostId}}/results\nAccept: text/event-stream\n\n### Simulate osquery returning results\nPOST http://localhost:8080/osquery/distributed_write\nContent-Type: application/json\n\n{\n  \"node_key\": \"{{nodeKey}}\",\n  \"statuses\": {\n    \"{{queryId}}\": 0\n  },\n  \"queries\": {\n    \"{{queryId}}\": [{\"test\": \"value\"}]\n  }\n}\n```\n\n**Acceptance Criteria:**\n- Full flow works end-to-end\n- SSE receives update within 500ms of distributed_write\n- Works with multiple concurrent SSE connections\n- Test can be run in CI (with real Postgres)\n- Manual test documented for development\n\n**Dependencies:**\n- All Phase 1-3 implementation complete\n- Server can start with pubsub enabled","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:44:52.48066626-05:00","updated_at":"2025-12-20T22:28:15.476591184-05:00","closed_at":"2025-12-20T22:28:15.476591184-05:00","close_reason":"Superseded by campaign-based design - end-to-end tests will be for campaign flow","dependencies":[{"issue_id":"queryops-msu","depends_on_id":"queryops-vwj","type":"blocks","created_at":"2025-12-20T20:46:45.436380726-05:00","created_by":"daemon"},{"issue_id":"queryops-msu","depends_on_id":"queryops-005","type":"blocks","created_at":"2025-12-20T20:46:45.472254399-05:00","created_by":"daemon"}]}
{"id":"queryops-n1y","title":"[Phase 4] Document configuration in README","description":"[Phase 6] Document configuration in README","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T20:45:03.967766554-05:00","updated_at":"2025-12-20T22:29:00.73410168-05:00","dependencies":[{"issue_id":"queryops-n1y","depends_on_id":"queryops-r2r","type":"blocks","created_at":"2025-12-20T20:46:45.505617253-05:00","created_by":"daemon"}]}
{"id":"queryops-nck","title":"Update User model for WebAuthn interface","description":"Modify User struct and repository to implement webauthn.User interface: WebAuthnID(), WebAuthnName(), WebAuthnDisplayName(), WebAuthnCredentials(). Add methods to load credentials for a user.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T17:26:09.907341802-05:00","updated_at":"2025-12-12T17:32:46.930669692-05:00","closed_at":"2025-12-12T17:32:46.930669692-05:00","dependencies":[{"issue_id":"queryops-nck","depends_on_id":"queryops-3j2","type":"blocks","created_at":"2025-12-12T17:27:07.837765127-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"queryops-nck","depends_on_id":"queryops-a05","type":"parent-child","created_at":"2025-12-12T17:27:23.630801989-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-oyh","title":"[Phase 2] Link distributed_queries to campaigns","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T22:28:21.511882471-05:00","updated_at":"2025-12-20T22:42:26.125758866-05:00","closed_at":"2025-12-20T22:42:26.125758866-05:00","close_reason":"No longer needed: osquery distributed query flow now uses campaigns/campaign_targets directly (campaign ID is the query ID).","labels":["database"],"dependencies":[{"issue_id":"queryops-oyh","depends_on_id":"queryops-5k9","type":"blocks","created_at":"2025-12-20T22:28:44.440501243-05:00","created_by":"daemon"}]}
{"id":"queryops-paz","title":"[Phase 2] Add publisher field to osquery Handlers struct","description":"Update the osquery Handlers struct to include a Watermill publisher.\n\n**File:** `features/osquery/handlers.go`\n\n**Current struct:**\n```go\ntype Handlers struct {\n    repo       hostRepository\n    orgService enrollmentOrgLookup\n}\n```\n\n**Updated struct:**\n```go\nimport (\n    \"github.com/ThreeDotsLabs/watermill/message\"\n    \"github.com/cavenine/queryops/internal/pubsub\"\n)\n\ntype Handlers struct {\n    repo       hostRepository\n    orgService enrollmentOrgLookup\n    publisher  message.Publisher  // For publishing query result events\n    pubsub     *pubsub.PubSub     // For creating subscribers in SSE handlers\n}\n```\n\n**Updated constructor:**\n```go\n// NewHandlers creates a new Handlers instance.\n// publisher and pubsub can be nil for graceful degradation to polling.\nfunc NewHandlers(\n    repo hostRepository,\n    orgService enrollmentOrgLookup,\n    publisher message.Publisher,\n    ps *pubsub.PubSub,\n) *Handlers {\n    return \u0026Handlers{\n        repo:       repo,\n        orgService: orgService,\n        publisher:  publisher,\n        pubsub:     ps,\n    }\n}\n```\n\n**Why both publisher and pubsub?**\n- `publisher` (message.Publisher interface) - Used in DistributedWrite to publish events. Interface allows mocking in tests.\n- `pubsub` (*pubsub.PubSub) - Used in SSE handlers to create per-connection subscribers. Concrete type because we need NewSubscriber().\n\n**Graceful degradation:**\n- If publisher is nil, DistributedWrite skips publishing (results still saved)\n- If pubsub is nil, SSE handlers fall back to polling\n\n**Acceptance Criteria:**\n- Struct updated with new fields\n- Constructor signature changed\n- All existing tests still compile (may need mock updates)\n- No functional changes yet (publishing not implemented)\n\n**Breaking change:**\nThis changes the NewHandlers signature. All callers must be updated:\n- features/osquery/routes.go\n- features/osquery/handlers_test.go","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:42:21.360720869-05:00","updated_at":"2025-12-20T21:41:38.579360319-05:00","closed_at":"2025-12-20T21:41:38.579360319-05:00","close_reason":"Extended osquery Handlers to accept optional Watermill publisher and *pubsub.PubSub; updated constructors/callers in routes and tests; go test ./... passes.","dependencies":[{"issue_id":"queryops-paz","depends_on_id":"queryops-e9t","type":"blocks","created_at":"2025-12-20T20:46:36.800509951-05:00","created_by":"daemon"}]}
{"id":"queryops-pbr","title":"Stop logging raw enrollment secrets","description":"The osquery enroll handler logs the provided enroll secret value when invalid.\n\nImpact: enrollment secrets can leak via log aggregation or operator access.\n\nProposed fix: remove the secret from logs, or log only a short prefix / hash.\n\nTouch points: features/osquery/handlers.go Enroll().","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-19T14:29:03.224760786-05:00","updated_at":"2025-12-19T14:36:09.777457646-05:00","closed_at":"2025-12-19T14:36:09.777457646-05:00","close_reason":"Closed","labels":["severity:high"]}
{"id":"queryops-pn9","title":"Create WebAuthn service","description":"New webauthn_service.go that initializes go-webauthn/webauthn library with RPID and origins. Implements BeginRegistration, FinishRegistration, BeginLogin, FinishLogin. Uses SCS session to store WebAuthn session data (challenges).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T17:26:18.39293392-05:00","updated_at":"2025-12-12T17:35:06.649189578-05:00","closed_at":"2025-12-12T17:35:06.649189578-05:00","dependencies":[{"issue_id":"queryops-pn9","depends_on_id":"queryops-d79","type":"blocks","created_at":"2025-12-12T17:27:11.468772527-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"queryops-pn9","depends_on_id":"queryops-nck","type":"blocks","created_at":"2025-12-12T17:27:11.487992757-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"queryops-pn9","depends_on_id":"queryops-a05","type":"parent-child","created_at":"2025-12-12T17:27:23.655899795-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-pux","title":"Passkey Authentication - Phase 2","description":"Account settings page for managing passkeys. Users can view registered passkeys, add new ones, and remove existing ones. Polish and UX improvements.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-12T17:26:01.293563359-05:00","updated_at":"2025-12-12T19:29:58.703325319-05:00","closed_at":"2025-12-12T19:29:58.703325319-05:00","dependencies":[{"issue_id":"queryops-pux","depends_on_id":"queryops-a05","type":"blocks","created_at":"2025-12-12T17:27:48.465642858-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-qbh","title":"[Phase 5] Add health check for pub/sub system","description":"[Phase 6] Add health check for pub/sub system","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T20:45:51.982533133-05:00","updated_at":"2025-12-20T22:29:00.799966894-05:00","dependencies":[{"issue_id":"queryops-qbh","depends_on_id":"queryops-vwj","type":"blocks","created_at":"2025-12-20T20:46:49.164632081-05:00","created_by":"daemon"}]}
{"id":"queryops-r2r","title":"[Phase 4] Add configuration options for pub/sub","description":"Add configuration options to control pub/sub behavior.\n\n**File:** `config/config.go`\n\n**New config fields:**\n```go\ntype Config struct {\n    // ... existing fields ...\n    \n    // PubSubEnabled enables the Watermill pub/sub system for real-time updates.\n    // If false, SSE handlers fall back to polling.\n    // Default: true\n    PubSubEnabled bool\n    \n    // PubSubPollInterval is how often the subscriber polls for new messages.\n    // Lower values = lower latency, higher DB load.\n    // Default: 100ms\n    PubSubPollInterval time.Duration\n    \n    // PubSubAutoInitSchema enables automatic schema creation.\n    // Set to false in production if using explicit migrations.\n    // Default: false in prod, true in dev\n    PubSubAutoInitSchema bool\n}\n```\n\n**Environment variables:**\n```bash\nPUBSUB_ENABLED=true          # Enable/disable pub/sub\nPUBSUB_POLL_INTERVAL=100ms   # Subscriber poll interval\nPUBSUB_AUTO_INIT_SCHEMA=false # Auto-create tables\n```\n\n**Loading from environment:**\n```go\nfunc Load() (*Config, error) {\n    cfg := \u0026Config{\n        // ... existing defaults ...\n        \n        PubSubEnabled:        getEnvBool(\"PUBSUB_ENABLED\", true),\n        PubSubPollInterval:   getEnvDuration(\"PUBSUB_POLL_INTERVAL\", 100*time.Millisecond),\n        PubSubAutoInitSchema: getEnvBool(\"PUBSUB_AUTO_INIT_SCHEMA\", false),\n    }\n    // ...\n}\n```\n\n**Usage in cmd/web/web.go:**\n```go\nvar ps *pubsub.PubSub\nif config.Global.PubSubEnabled {\n    ps, err = pubsub.New(egctx, pool, \u0026pubsub.Config{\n        AutoInitializeSchema: config.Global.PubSubAutoInitSchema,\n        PollInterval:         config.Global.PubSubPollInterval,\n    })\n    if err != nil {\n        // Log warning, continue without pubsub\n        slog.Warn(\"pubsub initialization failed, SSE will use polling\", \"error\", err)\n        ps = nil\n    } else {\n        defer ps.Close()\n    }\n}\n```\n\n**Development defaults (config/config_dev.go):**\n```go\nfunc init() {\n    // In dev, auto-init schema for convenience\n    if os.Getenv(\"PUBSUB_AUTO_INIT_SCHEMA\") == \"\" {\n        os.Setenv(\"PUBSUB_AUTO_INIT_SCHEMA\", \"true\")\n    }\n}\n```\n\n**Acceptance Criteria:**\n- Config fields added and documented\n- Environment variables read correctly\n- Defaults are sensible (enabled by default)\n- Dev mode has auto-init enabled\n- Prod mode requires explicit migration\n\n**Documentation:**\nUpdate README or deployment docs with new env vars.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:44:30.905881158-05:00","updated_at":"2025-12-20T21:49:54.677991342-05:00","closed_at":"2025-12-20T21:49:54.677991342-05:00","close_reason":"Added pubsub configuration flags (PUBSUB_ENABLED, PUBSUB_POLL_INTERVAL, PUBSUB_AUTO_INIT_SCHEMA) to config and wired into cmd/web/web.go pubsub initialization; dev defaults auto-init schema unless env set; go test ./... passes.","dependencies":[{"issue_id":"queryops-r2r","depends_on_id":"queryops-e9t","type":"blocks","created_at":"2025-12-20T20:46:45.402041405-05:00","created_by":"daemon"}]}
{"id":"queryops-ro2","title":"Integrate CTRF test reporting in CI","description":"Add go-ctrf-json-reporter (Go tool directive), generate CTRF JSON from go test output, and publish job summary + sticky PR comment via github-test-reporter (overwrite mode).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T17:22:30.720143857-05:00","updated_at":"2025-12-20T17:24:28.492214087-05:00","closed_at":"2025-12-20T17:24:28.492214087-05:00","close_reason":"Implemented CTRF Taskfile + CI workflow","comments":[{"id":1,"issue_id":"queryops-ro2","author":"ben","text":"Implemented CTRF reporting: added go-ctrf-json-reporter as go.mod tool, added Taskfile tasks tools:ctrf-reporter and test:all:ctrf emitting ctrf/unit.json + ctrf/integration.json, updated .github/workflows/tests.yml to publish job summary + overwrite sticky PR comment via ctrf-io/github-test-reporter@v1 (if: always) and added ctrf/ to .gitignore.","created_at":"2025-12-20T22:24:28Z"}]}
{"id":"queryops-s1b","title":"bd sync fails when worktree already on main","description":"Running 'bd sync' in /home/ben/source/queryops on branch main fails with: 'Error committing to sync branch: failed to create worktree: exit status 128; fatal: 'main' is already used by worktree at '/home/ben/source/queryops''. This prevents using bd sync in a single-worktree clone. Workaround: commit .beads files directly via git.","status":"closed","issue_type":"bug","created_at":"2025-12-11T22:07:38.502606496-05:00","updated_at":"2025-12-12T17:29:28.183473159-05:00","closed_at":"2025-12-12T17:29:28.183473159-05:00"}
{"id":"queryops-se3","title":"[Phase 2] Define QueryResultEvent type and topic naming","description":"Define the event type published when distributed query results are saved.\n\n**File:** `internal/pubsub/events.go`\n\n**Topic naming function:**\n```go\n// TopicQueryResults returns the topic name for a host's query results.\n// Format: query_results:{host-uuid}\n// Example: query_results:550e8400-e29b-41d4-a716-446655440000\nfunc TopicQueryResults(hostID uuid.UUID) string {\n    return fmt.Sprintf(\"query_results:%s\", hostID.String())\n}\n```\n\n**Event structure:**\n```go\n// QueryResultEvent is published when distributed query results are saved.\ntype QueryResultEvent struct {\n    // HostID is the host that executed the query.\n    HostID uuid.UUID `json:\"host_id\"`\n    \n    // QueryID is the distributed query ID.\n    QueryID uuid.UUID `json:\"query_id\"`\n    \n    // Status is the result status: \"completed\" or \"failed\".\n    Status string `json:\"status\"`\n    \n    // OccurredAt is when the result was saved.\n    OccurredAt time.Time `json:\"occurred_at\"`\n    \n    // Error is set if status is \"failed\".\n    Error *string `json:\"error,omitempty\"`\n}\n```\n\n**Message conversion methods:**\n```go\n// ToMessage converts the event to a Watermill message.\nfunc (e QueryResultEvent) ToMessage() *message.Message {\n    payload, _ := json.Marshal(e)\n    msg := message.NewMessage(uuid.New().String(), payload)\n    msg.Metadata.Set(\"event_type\", \"query_result\")\n    msg.Metadata.Set(\"host_id\", e.HostID.String())\n    msg.Metadata.Set(\"query_id\", e.QueryID.String())\n    return msg\n}\n\n// ParseQueryResultEvent parses a Watermill message into a QueryResultEvent.\nfunc ParseQueryResultEvent(msg *message.Message) (QueryResultEvent, error) {\n    var event QueryResultEvent\n    if err := json.Unmarshal(msg.Payload, \u0026event); err != nil {\n        return event, fmt.Errorf(\"parsing query result event: %w\", err)\n    }\n    return event, nil\n}\n```\n\n**Design decisions:**\n- Topic per host (not per query) - matches UI subscription pattern\n- Metadata includes IDs for filtering/debugging without parsing payload\n- OccurredAt captures server time, not osquery execution time\n- Error field only present on failure (omitempty)\n\n**Acceptance Criteria:**\n- Types compile and are exported\n- JSON serialization round-trips correctly\n- ToMessage/ParseQueryResultEvent are inverse operations\n- Unit tests for serialization\n\n**Unit test:**\n```go\nfunc TestQueryResultEvent_Serialization(t *testing.T) {\n    original := QueryResultEvent{\n        HostID:     uuid.New(),\n        QueryID:    uuid.New(),\n        Status:     \"completed\",\n        OccurredAt: time.Now().Truncate(time.Second),\n    }\n    \n    msg := original.ToMessage()\n    parsed, err := ParseQueryResultEvent(msg)\n    \n    require.NoError(t, err)\n    assert.Equal(t, original.HostID, parsed.HostID)\n    assert.Equal(t, original.QueryID, parsed.QueryID)\n    assert.Equal(t, original.Status, parsed.Status)\n}\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:42:09.632911905-05:00","updated_at":"2025-12-20T21:19:21.530996969-05:00","closed_at":"2025-12-20T21:19:21.530996969-05:00","close_reason":"Implemented QueryResultEvent + TopicQueryResults and added serialization round-trip unit test in internal/pubsub/events_test.go.","dependencies":[{"issue_id":"queryops-se3","depends_on_id":"queryops-e9t","type":"blocks","created_at":"2025-12-20T20:46:36.751039737-05:00","created_by":"daemon"}]}
{"id":"queryops-vde","title":"Create passkey handlers and routes","description":"New passkey_handlers.go with 4 endpoints: POST /passkey/register/begin (auth required), POST /passkey/register/finish (auth required), POST /passkey/login/begin (public), POST /passkey/login/finish (public). Wire up routes in routes.go.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T17:26:22.47193991-05:00","updated_at":"2025-12-12T17:36:32.987776768-05:00","closed_at":"2025-12-12T17:36:32.987776768-05:00","dependencies":[{"issue_id":"queryops-vde","depends_on_id":"queryops-pn9","type":"blocks","created_at":"2025-12-12T17:27:14.903143286-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"queryops-vde","depends_on_id":"queryops-a05","type":"parent-child","created_at":"2025-12-12T17:27:23.667292724-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-vwj","title":"[Phase 4] Update router.SetupRoutes to accept and pass PubSub","description":"Update the main router setup to accept and propagate the PubSub instance.\n\n**File:** `router/router.go`\n\n**Current signature:**\n```go\nfunc SetupRoutes(_ context.Context, router chi.Router, sessionManager *scs.SessionManager, pool *pgxpool.Pool) error\n```\n\n**Updated signature:**\n```go\nimport (\n    \"github.com/cavenine/queryops/internal/pubsub\"\n)\n\nfunc SetupRoutes(\n    _ context.Context,\n    router chi.Router,\n    sessionManager *scs.SessionManager,\n    pool *pgxpool.Pool,\n    ps *pubsub.PubSub, // NEW: Can be nil for graceful degradation\n) error\n```\n\n**Updated calls to osquery feature:**\n```go\n// Current\nosqueryFeature.SetupRoutes(router, pool, orgService)\n// ...\nosqueryFeature.SetupProtectedRoutes(r, pool, orgService)\n\n// Updated\nosqueryFeature.SetupRoutes(router, pool, orgService, ps)\n// ...\nosqueryFeature.SetupProtectedRoutes(r, pool, orgService, ps)\n```\n\n**Full context of changes:**\n```go\nfunc SetupRoutes(_ context.Context, router chi.Router, sessionManager *scs.SessionManager, pool *pgxpool.Pool, ps *pubsub.PubSub) error {\n    // ... existing setup ...\n    \n    // Osquery endpoints (public)\n    osqueryFeature.SetupRoutes(router, pool, orgService, ps)\n    \n    // ... auth setup ...\n    \n    router.Group(func(r chi.Router) {\n        // ... auth middleware ...\n        \n        r.Group(func(r chi.Router) {\n            r.Use(organizationFeature.RequireOrganization(orgService, sessionManager))\n            \n            osqueryFeature.SetupProtectedRoutes(r, pool, orgService, ps)\n            \n            // ... other protected routes (unchanged) ...\n        })\n    })\n    \n    return nil\n}\n```\n\n**Caller update (cmd/web/web.go):**\n```go\n// Current\nif setupErr := router.SetupRoutes(egctx, r, sessionManager, pool); setupErr != nil {\n\n// Updated\nif setupErr := router.SetupRoutes(egctx, r, sessionManager, pool, ps); setupErr != nil {\n```\n\n**Graceful degradation:**\nIf `ps` is nil, osquery features will fall back to polling. This allows:\n- Running without pubsub in tests\n- Graceful startup if pubsub init fails\n- Incremental rollout\n\n**Acceptance Criteria:**\n- SetupRoutes accepts PubSub parameter\n- Parameter passed to osquery feature setup\n- Server starts with ps=nil (graceful degradation)\n- Server starts with valid ps\n- No other features affected\n\n**Dependencies:**\n- osquery routes updated to accept PubSub\n- cmd/web/web.go initializes PubSub","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:44:17.028074231-05:00","updated_at":"2025-12-20T21:45:37.336742716-05:00","closed_at":"2025-12-20T21:45:37.336742716-05:00","close_reason":"router.SetupRoutes now accepts *pubsub.PubSub and passes it through to osquery routes; cmd/web/web.go initializes pubsub with graceful degradation; go test ./... passes.","dependencies":[{"issue_id":"queryops-vwj","depends_on_id":"queryops-lid","type":"blocks","created_at":"2025-12-20T20:46:45.327789579-05:00","created_by":"daemon"},{"issue_id":"queryops-vwj","depends_on_id":"queryops-dr2","type":"blocks","created_at":"2025-12-20T20:46:45.368867339-05:00","created_by":"daemon"}]}
{"id":"queryops-we9","title":"Fix nilnil issues","description":"Address return of (nil, nil) in credential, user, and todo repositories","status":"closed","issue_type":"task","created_at":"2025-12-17T23:01:00.467482457-05:00","updated_at":"2025-12-17T23:19:56.267783666-05:00","closed_at":"2025-12-17T23:19:56.267783666-05:00","dependencies":[{"issue_id":"queryops-we9","depends_on_id":"queryops-8tj","type":"parent-child","created_at":"2025-12-17T23:01:03.333394742-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-wsf","title":"Switch images to Debian Trixie (no musl)","description":"Update Dockerfile runtime to debian:trixie-slim (and build stage to a glibc Go image). Also switch postgres accessory off alpine.","status":"closed","priority":1,"issue_type":"chore","created_at":"2025-12-12T21:50:44.195175631-05:00","updated_at":"2025-12-12T21:52:03.258393173-05:00","closed_at":"2025-12-12T21:52:03.258393173-05:00","dependencies":[{"issue_id":"queryops-wsf","depends_on_id":"queryops-1ox","type":"parent-child","created_at":"2025-12-12T21:50:47.047117259-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-wve","title":"Bump Postgres accessory to 18","description":"Use postgres:18-alpine in config/deploy.yml and keep README/runbook consistent.","status":"closed","priority":1,"issue_type":"chore","created_at":"2025-12-12T21:48:53.726471566-05:00","updated_at":"2025-12-12T21:49:12.289473223-05:00","closed_at":"2025-12-12T21:49:12.289473223-05:00","dependencies":[{"issue_id":"queryops-wve","depends_on_id":"queryops-1ox","type":"parent-child","created_at":"2025-12-12T21:48:58.264001332-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-wzs","title":"[Phase 4] Modify DistributedWrite to publish to campaign topic","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:28:34.158980523-05:00","updated_at":"2025-12-20T22:46:31.434972536-05:00","closed_at":"2025-12-20T22:46:31.434972536-05:00","close_reason":"DistributedWrite now publishes both host-scoped QueryResultEvent and campaign-scoped CampaignResultEvent (topic campaign:{campaign_id}). Updated unit tests accordingly.","labels":["backend"],"dependencies":[{"issue_id":"queryops-wzs","depends_on_id":"queryops-0io","type":"blocks","created_at":"2025-12-20T22:28:47.159625696-05:00","created_by":"daemon"}]}
{"id":"queryops-x4v","title":"Fix gosec issues","description":"Address G301 (permissions), G107 (dynamic URL), and G112 (Slowloris) security concerns","status":"closed","issue_type":"task","created_at":"2025-12-17T23:01:00.456927701-05:00","updated_at":"2025-12-17T23:13:48.045950833-05:00","closed_at":"2025-12-17T23:13:48.045950833-05:00","dependencies":[{"issue_id":"queryops-x4v","depends_on_id":"queryops-8tj","type":"parent-child","created_at":"2025-12-17T23:01:03.323882181-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-xrf","title":"[Phase 3] Implement GET /api/v1/campaigns endpoint (list)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T22:28:27.86771825-05:00","updated_at":"2025-12-20T22:46:28.122784395-05:00","closed_at":"2025-12-20T22:46:28.122784395-05:00","close_reason":"Added GET /api/v1/campaigns (ListCampaigns) returning recent campaigns for active org.","labels":["backend"],"dependencies":[{"issue_id":"queryops-xrf","depends_on_id":"queryops-0io","type":"blocks","created_at":"2025-12-20T22:28:46.082870499-05:00","created_by":"daemon"}]}
{"id":"queryops-xuz","title":"[Epic] Live Query Results Streaming via SSE with Watermill","description":"[Epic] Live Query Results Streaming via SSE with Watermill - Campaign-Based Design","status":"open","priority":1,"issue_type":"feature","created_at":"2025-12-20T20:40:58.981715746-05:00","updated_at":"2025-12-20T22:28:03.057142897-05:00","dependencies":[{"issue_id":"queryops-xuz","depends_on_id":"queryops-msu","type":"blocks","created_at":"2025-12-20T20:46:53.669704316-05:00","created_by":"daemon"},{"issue_id":"queryops-xuz","depends_on_id":"queryops-8uk","type":"blocks","created_at":"2025-12-20T20:46:53.712486527-05:00","created_by":"daemon"},{"issue_id":"queryops-xuz","depends_on_id":"queryops-4ze","type":"blocks","created_at":"2025-12-20T20:46:53.74937348-05:00","created_by":"daemon"},{"issue_id":"queryops-xuz","depends_on_id":"queryops-qbh","type":"blocks","created_at":"2025-12-20T20:46:53.785447268-05:00","created_by":"daemon"},{"issue_id":"queryops-xuz","depends_on_id":"queryops-7a1","type":"blocks","created_at":"2025-12-20T20:46:53.820267898-05:00","created_by":"daemon"},{"issue_id":"queryops-xuz","depends_on_id":"queryops-6wi","type":"blocks","created_at":"2025-12-20T20:46:53.854616458-05:00","created_by":"daemon"},{"issue_id":"queryops-xuz","depends_on_id":"queryops-n1y","type":"blocks","created_at":"2025-12-20T20:46:53.890551982-05:00","created_by":"daemon"}],"comments":[{"id":3,"issue_id":"queryops-xuz","author":"ben","text":"PIVOT: Changed from host-based topics (query_results:{host_id}) to campaign-based topics (campaign:{campaign_id}). This enables: 1) Dedicated query execution UX 2) Multi-host result aggregation 3) Campaign audit/history 4) Filtering results to specific queries. Phase 1 (infrastructure) is complete. Phases 2-6 need updates for campaign model.","created_at":"2025-12-21T03:28:11Z"}]}
{"id":"queryops-xwt","title":"Enforce tenant scoping for hosts listing/details","description":"Multi-tenant requirement: users must only see hosts in their active organization.\n\nCurrent behavior:\n- Hosts list returns all hosts (no org filter).\n- Host details loads by host UUID with no org check.\n\nImpact: cross-organization data exposure once \u003e1 org exists.\n\nProposed fix: add org-scoped repo methods and enforce org checks in handlers; return 404 on org mismatch.\n\nTouch points: features/osquery/handlers.go, features/osquery/services/host_repository.go","status":"closed","issue_type":"bug","created_at":"2025-12-19T14:28:55.859967921-05:00","updated_at":"2025-12-19T14:36:09.738302112-05:00","closed_at":"2025-12-19T14:36:09.738302112-05:00","close_reason":"Closed","labels":["severity:high"]}
{"id":"queryops-xzb","title":"Add osquery agent API handler test coverage","description":"Increase test coverage for core osquery TLS backend endpoints (/osquery/*) using table-driven httptest-based handler tests. Focus on correctness of JSON parsing, node_invalid behavior, and repo/org-service call semantics without requiring Postgres by injecting stub interfaces.","design":"Refactor features/osquery Handlers to depend on small interfaces (hostRepo + orgLookup) rather than concrete *HostRepository/*OrganizationService. In tests, use stub implementations recording calls and allowing injected errors. Use chi router + httptest with JSON requests.","acceptance_criteria":"Table-driven tests cover Enroll, Config, Logger, DistributedRead, DistributedWrite branches; tests run without DB; go test ./... passes.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-20T16:02:57.560168186-05:00","updated_at":"2025-12-20T16:51:15.205113692-05:00","closed_at":"2025-12-20T16:51:15.205113692-05:00","close_reason":"Implemented DI-friendly osquery handlers, removed stray fmt.Println, and added httptest coverage for enroll/config/logger/distributed read+write; go test ./... passes."}
{"id":"queryops-xzb.1","title":"Refactor osquery handlers for DI-friendly interfaces","description":"Replace concrete deps in features/osquery/handlers.go (repo *services.HostRepository, orgService *OrganizationService) with minimal interfaces so handler tests can use stubs and avoid Postgres.","design":"Define interfaces in features/osquery (e.g. type hostRepo interface { GetByNodeKey; Enroll; SaveStatusLogs; SaveResultLogs; GetConfigForHost; UpdateLastConfig/Logger/Distributed; GetPendingQueries; SaveQueryResults } and type orgLookup interface { GetOrganizationByEnrollSecret }). Update Handlers struct and NewHandlers signature; update routes.go to pass concrete implementations.","acceptance_criteria":"All build passes; no behavior change; routes.go still wires concrete services; tests can instantiate Handlers with stub deps.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T16:03:04.351821319-05:00","updated_at":"2025-12-20T16:51:15.197038528-05:00","closed_at":"2025-12-20T16:51:15.197038528-05:00","close_reason":"Implemented DI-friendly osquery handlers, removed stray fmt.Println, and added httptest coverage for enroll/config/logger/distributed read+write; go test ./... passes.","dependencies":[{"issue_id":"queryops-xzb.1","depends_on_id":"queryops-xzb","type":"parent-child","created_at":"2025-12-20T16:03:04.359982015-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-xzb.2","title":"Add table-driven tests for /osquery/enroll","description":"Add httptest coverage for Enroll handler. Ensure node_invalid behavior and error paths are correct.","design":"Create features/osquery/handlers_test.go (or enroll_test.go) using chi router. Use stub orgLookup + stub hostRepo. Test cases (table-driven): invalid JSON =\u003e 400; org not found (ErrOrganizationNotFound or nil org) =\u003e 200 with {node_invalid:true}; org service error =\u003e 500; success =\u003e 200 with node_key and hostRepo.Enroll called with host_identifier + host_details + orgID.","acceptance_criteria":"Tests are table-driven, deterministic, no DB. go test ./features/osquery passes.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T16:03:07.883849259-05:00","updated_at":"2025-12-20T16:51:15.200445354-05:00","closed_at":"2025-12-20T16:51:15.200445354-05:00","close_reason":"Implemented DI-friendly osquery handlers, removed stray fmt.Println, and added httptest coverage for enroll/config/logger/distributed read+write; go test ./... passes.","dependencies":[{"issue_id":"queryops-xzb.2","depends_on_id":"queryops-xzb","type":"parent-child","created_at":"2025-12-20T16:03:07.891805686-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-xzb.3","title":"Add table-driven tests for /osquery/config","description":"Add httptest coverage for Config handler, including node_invalid and config passthrough.","design":"Table-driven cases: invalid JSON =\u003e 400; unknown nodeKey or repo error =\u003e node_invalid true response; UpdateLastConfig error only logs (should still return config); GetConfigForHost error =\u003e 500; valid config JSON from repo is unmarshaled into ConfigResponse and returned.","acceptance_criteria":"Covers branch behavior and JSON response shape; tests run without DB.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T16:03:10.35230929-05:00","updated_at":"2025-12-20T16:51:15.201250065-05:00","closed_at":"2025-12-20T16:51:15.201250065-05:00","close_reason":"Implemented DI-friendly osquery handlers, removed stray fmt.Println, and added httptest coverage for enroll/config/logger/distributed read+write; go test ./... passes.","dependencies":[{"issue_id":"queryops-xzb.3","depends_on_id":"queryops-xzb","type":"parent-child","created_at":"2025-12-20T16:03:10.359735955-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-xzb.4","title":"Add table-driven tests for /osquery/logger","description":"Add httptest coverage for Logger handler for both status and result log types, ensuring modern osquery numeric fields parse and repo save methods are called.","design":"Table-driven cases: invalid JSON =\u003e 400; unknown nodeKey =\u003e {node_invalid:true}; log_type=status =\u003e SaveStatusLogs called per entry with line/severity numeric; log_type=result =\u003e SaveResultLogs called with name/action/columns. Use stub repo recording saves. Verify handler always returns 200 with {} unless invalid request.","acceptance_criteria":"Prevents regressions like severity unmarshalling bug; verifies calls \u0026 key fields. Tests are table-driven.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T16:03:12.949610926-05:00","updated_at":"2025-12-20T16:51:15.202004046-05:00","closed_at":"2025-12-20T16:51:15.202004046-05:00","close_reason":"Implemented DI-friendly osquery handlers, removed stray fmt.Println, and added httptest coverage for enroll/config/logger/distributed read+write; go test ./... passes.","dependencies":[{"issue_id":"queryops-xzb.4","depends_on_id":"queryops-xzb","type":"parent-child","created_at":"2025-12-20T16:03:12.957460917-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-xzb.5","title":"Add table-driven tests for /osquery/distributed_read","description":"Add httptest coverage for DistributedRead handler.","design":"Cases: invalid JSON =\u003e 400; unknown nodeKey =\u003e {node_invalid:true}; GetPendingQueries error =\u003e returns {queries:{}} (node_invalid false); success =\u003e returns queries map. Stub repo returns host + queries.","acceptance_criteria":"Tests are table-driven; no DB; verifies JSON response.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T16:03:14.395857341-05:00","updated_at":"2025-12-20T16:51:15.202849146-05:00","closed_at":"2025-12-20T16:51:15.202849146-05:00","close_reason":"Implemented DI-friendly osquery handlers, removed stray fmt.Println, and added httptest coverage for enroll/config/logger/distributed read+write; go test ./... passes.","dependencies":[{"issue_id":"queryops-xzb.5","depends_on_id":"queryops-xzb","type":"parent-child","created_at":"2025-12-20T16:03:14.40226593-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-xzb.6","title":"Add table-driven tests for /osquery/distributed_write","description":"Add httptest coverage for DistributedWrite handler: statuses map path vs results-only path, status handling, and invalid query IDs.","design":"Table-driven cases: invalid JSON =\u003e 400; unknown nodeKey =\u003e {node_invalid:true}; statuses empty =\u003e iterate req.Queries and SaveQueryResults status=completed; statuses present =\u003e statusCode 0 =\u003e completed; nonzero =\u003e failed + errorText 'osquery status N'; invalid UUID keys are skipped (no SaveQueryResults call). Stub repo records SaveQueryResults args.","acceptance_criteria":"Covers both branches; ensures no panics on invalid IDs; tests table-driven and deterministic.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T16:03:16.584756923-05:00","updated_at":"2025-12-20T16:51:15.203611953-05:00","closed_at":"2025-12-20T16:51:15.203611953-05:00","close_reason":"Implemented DI-friendly osquery handlers, removed stray fmt.Println, and added httptest coverage for enroll/config/logger/distributed read+write; go test ./... passes.","dependencies":[{"issue_id":"queryops-xzb.6","depends_on_id":"queryops-xzb","type":"parent-child","created_at":"2025-12-20T16:03:16.593376372-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"queryops-z8c","title":"[Phase 2] Add unit tests with mock publisher","description":"Add unit tests for the publish behavior in DistributedWrite handler.\n\n**File:** `features/osquery/handlers_test.go`\n\n**Mock publisher:**\n```go\ntype mockPublisher struct {\n    publishCalls []struct {\n        topic    string\n        messages []*message.Message\n    }\n    err error\n}\n\nfunc (m *mockPublisher) Publish(topic string, messages ...*message.Message) error {\n    m.publishCalls = append(m.publishCalls, struct {\n        topic    string\n        messages []*message.Message\n    }{topic, messages})\n    return m.err\n}\n\nfunc (m *mockPublisher) Close() error {\n    return nil\n}\n```\n\n**Test cases:**\n\n1. **TestDistributedWrite_PublishesEventOnSuccess**\n```go\nfunc TestDistributedWrite_PublishesEventOnSuccess(t *testing.T) {\n    repo := \u0026stubHostRepository{\n        host: \u0026services.Host{ID: hostID, ...},\n    }\n    pub := \u0026mockPublisher{}\n    h := NewHandlers(repo, nil, pub, nil)\n    \n    req := DistributedWriteRequest{\n        NodeKey:  \"valid-key\",\n        Statuses: map[string]int{queryID.String(): 0},\n        Queries:  map[string][]map[string]string{queryID.String(): {}},\n    }\n    body, _ := json.Marshal(req)\n    r := httptest.NewRequest(\"POST\", \"/distributed_write\", bytes.NewReader(body))\n    w := httptest.NewRecorder()\n    \n    h.DistributedWrite(w, r)\n    \n    require.Equal(t, http.StatusOK, w.Code)\n    require.Len(t, pub.publishCalls, 1)\n    assert.Contains(t, pub.publishCalls[0].topic, hostID.String())\n}\n```\n\n2. **TestDistributedWrite_PublishFailureDoesNotFailRequest**\n```go\nfunc TestDistributedWrite_PublishFailureDoesNotFailRequest(t *testing.T) {\n    repo := \u0026stubHostRepository{host: \u0026services.Host{ID: hostID}}\n    pub := \u0026mockPublisher{err: errors.New(\"publish failed\")}\n    h := NewHandlers(repo, nil, pub, nil)\n    \n    // ... make request ...\n    \n    assert.Equal(t, http.StatusOK, w.Code) // Request still succeeds\n    assert.True(t, repo.saveQueryResultsCalled) // Results still saved\n}\n```\n\n3. **TestDistributedWrite_NilPublisher_GracefulDegradation**\n```go\nfunc TestDistributedWrite_NilPublisher_GracefulDegradation(t *testing.T) {\n    repo := \u0026stubHostRepository{host: \u0026services.Host{ID: hostID}}\n    h := NewHandlers(repo, nil, nil, nil) // No publisher\n    \n    // ... make request ...\n    \n    assert.Equal(t, http.StatusOK, w.Code) // Works without publisher\n}\n```\n\n4. **TestDistributedWrite_SkipsPublishOnSaveFailure**\n```go\nfunc TestDistributedWrite_SkipsPublishOnSaveFailure(t *testing.T) {\n    repo := \u0026stubHostRepository{\n        host:                \u0026services.Host{ID: hostID},\n        saveQueryResultsErr: errors.New(\"db error\"),\n    }\n    pub := \u0026mockPublisher{}\n    h := NewHandlers(repo, nil, pub, nil)\n    \n    // ... make request ...\n    \n    assert.Len(t, pub.publishCalls, 0) // No publish on save failure\n}\n```\n\n5. **TestDistributedWrite_MultipleResults_PublishesMultipleEvents**\n```go\nfunc TestDistributedWrite_MultipleResults_PublishesMultipleEvents(t *testing.T) {\n    // Send 3 query results\n    // Verify 3 publish calls\n}\n```\n\n**Update existing tests:**\nAny existing tests for DistributedWrite need updated constructor calls:\n```go\n// Before\nh := NewHandlers(repo, orgService)\n// After\nh := NewHandlers(repo, orgService, nil, nil)\n```\n\n**Acceptance Criteria:**\n- All new tests pass\n- Existing tests updated and pass\n- Mock publisher is reusable for other tests\n- Tests cover success, failure, and edge cases\n- No flaky tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:43:09.153370162-05:00","updated_at":"2025-12-20T21:48:25.30406849-05:00","closed_at":"2025-12-20T21:48:25.30406849-05:00","close_reason":"Added mock Watermill publisher and unit tests verifying DistributedWrite publishes QueryResultEvent on successful SaveQueryResults and skips publishing on save failure.","dependencies":[{"issue_id":"queryops-z8c","depends_on_id":"queryops-1ca","type":"blocks","created_at":"2025-12-20T20:46:36.983290342-05:00","created_by":"daemon"},{"issue_id":"queryops-z8c","depends_on_id":"queryops-paz","type":"blocks","created_at":"2025-12-20T20:46:37.019331851-05:00","created_by":"daemon"}]}
{"id":"queryops-zyu","title":"[Phase 1] Initialize PubSub in web server startup","description":"Add PubSub initialization to the web server startup sequence.\n\n**File:** `cmd/web/web.go`\n\n**Changes:**\n\n1. Import pubsub package:\n```go\nimport \"github.com/cavenine/queryops/internal/pubsub\"\n```\n\n2. Initialize after pool creation:\n```go\n// After pool creation and before router setup\nps, err := pubsub.New(egctx, pool, \u0026pubsub.Config{\n    AutoInitializeSchema: false, // Using explicit migrations\n})\nif err != nil {\n    return fmt.Errorf(\"creating pubsub: %w\", err)\n}\ndefer ps.Close()\n```\n\n3. Pass to router setup:\n```go\nif setupErr := router.SetupRoutes(egctx, r, sessionManager, pool, ps); setupErr != nil {\n    return fmt.Errorf(\"error setting up routes: %w\", setupErr)\n}\n```\n\n**Graceful degradation option:**\n```go\nps, err := pubsub.New(egctx, pool, nil)\nif err != nil {\n    slog.Warn(\"pubsub initialization failed, SSE will use polling\", \"error\", err)\n    ps = nil // Handlers will fall back to polling\n}\nif ps != nil {\n    defer ps.Close()\n}\n```\n\n**Acceptance Criteria:**\n- PubSub initializes on server start\n- Graceful shutdown via defer\n- Server starts even if pubsub fails (warning logged)\n- Signature change to SetupRoutes is compatible\n\n**Dependencies:**\n- internal/pubsub package must exist\n- Migration must have run","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T20:41:43.355731446-05:00","updated_at":"2025-12-20T21:18:53.546740945-05:00","closed_at":"2025-12-20T21:18:53.546740945-05:00","close_reason":"Initialized internal/pubsub in cmd/web/web.go with graceful degradation; router.SetupRoutes now accepts optional *pubsub.PubSub; go test ./... passes.","dependencies":[{"issue_id":"queryops-zyu","depends_on_id":"queryops-e9t","type":"blocks","created_at":"2025-12-20T20:46:32.439034806-05:00","created_by":"daemon"},{"issue_id":"queryops-zyu","depends_on_id":"queryops-chv","type":"blocks","created_at":"2025-12-20T20:46:32.473165142-05:00","created_by":"daemon"},{"issue_id":"queryops-zyu","depends_on_id":"queryops-ltn","type":"blocks","created_at":"2025-12-20T20:46:32.506905335-05:00","created_by":"daemon"}]}
