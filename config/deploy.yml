# Kamal deployment configuration (single DigitalOcean VM)
#
# Usage:
#   kamal setup
#   kamal deploy
#
# Secrets are read from:
#   .kamal/secrets-common
#   .kamal/secrets
#
# See README.md for a full runbook.

ssh:
  user: deploy

service: queryops
image: cavenine/queryops

servers:
  web:
    hosts:
      - 165.245.135.75
  workers:
    hosts:
      - 165.245.135.75
    cmd: worker
    proxy: false

proxy:
  hosts:
    - app.queryops.com
  app_port: 8080
  ssl: true
  healthcheck:
    path: /up
    interval: 1
    timeout: 5

env:
  clear:
    HOST: 0.0.0.0
    PORT: "8080"
    AUTO_MIGRATE: "false"
  secret:
    - DATABASE_URL
    - SESSION_SECRET
    - WEBAUTHN_RP_ID
    - WEBAUTHN_RP_ORIGIN
    - WEBAUTHN_RP_DISPLAY_NAME

registry:
  server: ghcr.io
  username: cavenine
  password:
    - KAMAL_REGISTRY_PASSWORD

builder:
  arch: amd64

accessories:
  postgres:
    service: postgres
    image: postgres:18
    roles:
      - web
    directories:
      - postgres-data-v18:/var/lib/postgresql
    port: "5432:5432"
    cmd: "postgres -c shared_buffers=128MB -c effective_cache_size=256MB -c max_connections=20 -c work_mem=2MB -c maintenance_work_mem=32MB -c random_page_cost=1.1 -c hash_mem_multiplier=1.5 -c autovacuum_work_mem=16MB"
    options:
      memory: 512m
      shm-size: 128m
    env:
      clear:
        POSTGRES_USER: queryops
        POSTGRES_DB: queryops
      secret:
        - POSTGRES_PASSWORD
