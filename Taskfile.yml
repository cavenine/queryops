version: "3"

dotenv:
  - .env

env:
  NATS_PORT: 4222
  STATIC_DIR: "web/resources/static"
  GOEXPERIMENT: "greenteagc,jsonv2"

tasks:
  # The `build:` tasks below are used together for production builds of a project
  build:templ:
    cmds:
      - go tool templ generate
    sources:
      - "**/*.templ"
    generates:
      - "**/*_templ.go"

  build:styles:
    cmds:
      - go tool gotailwind -i web/resources/styles/styles.css -o $STATIC_DIR/index.css
    sources:
      - "./web/resources/**/*.{html,ts,templ,go,css}"
    generates:
      - "{{.STATIC_DIR}}/index.css"

  build:wc:
    cmds:
      - go run cmd/web/build/main.go
    sources:
      - "./web/libs/**/**/*.{html,css,ts}"
    generates:
      - "{{.STATIC_DIR}}/libs/**"

  build:
    cmds:
      - go build -tags=prod -o bin/queryops ./cmd
    deps:
      - build:templ
      - build:styles
      - build:wc

  ghcr:login:
    desc: Login to GitHub Container Registry
    cmds:
      - echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin
    preconditions:
      - sh: test -n "$GHCR_USERNAME"
        msg: GHCR_USERNAME is required
      - sh: test -n "$GHCR_TOKEN"
        msg: GHCR_TOKEN is required (classic PAT with write:packages)

  ghcr:publish:
    desc: Build and push image to GHCR
    deps:
      - ghcr:login
    vars:
      GIT_SHA:
        sh: git rev-parse --short HEAD
    preconditions:
      - sh: test -n "$GHCR_IMAGE"
        msg: 'GHCR_IMAGE is required (example: ghcr.io/<owner>/<repo>)'
    cmds:
      - docker buildx build --platform linux/amd64 --tag "$GHCR_IMAGE:latest" --tag "$GHCR_IMAGE:dev-{{.GIT_SHA}}" --push .

  docker:build:
    desc: Build local Docker image (no push)
    vars:
      GIT_SHA:
        sh: git rev-parse --short HEAD
    cmds:
      - docker build -t "${DOCKER_IMAGE:-queryops}:local" -t "${DOCKER_IMAGE:-queryops}:local-{{.GIT_SHA}}" .

  # Use this task to debug with the delve debugger
  debug:
    cmds:
      - go tool dlv exec ./bin/queryops
    deps:
      - build

  # Use this task to download latest version of client libs
  download:
    cmds:
      - go run cmd/web/downloader/main.go

  # The `live:` tasks below are used together for development builds and will live-reload the server
  live:templ:
    cmds:
      - go tool templ generate -watch

  live:styles:
    cmds:
      - go tool gotailwind -i web/resources/styles/styles.css -o $STATIC_DIR/index.css -w

  live:wc:
    cmds:
      - go run cmd/web/build/main.go -watch

  live:server:
    cmds:
      - |
        go tool air  \
          -build.cmd "go build -tags=dev -o tmp/bin/queryops ./cmd" \
         -build.bin "tmp/bin/queryops" \

         -build.args_bin "web" \
         -build.exclude_dir "data,node_modules,web/resources/libs/datastar/node_modules,web/resources/libs/lit/node_modules" \
         -build.include_ext "go,templ" \
         -misc.clean_on_exit "true"

  live:
    deps:
      - live:templ
      - live:styles
      - live:wc
      - live:server

  run:
    cmds:
      - ./bin/queryops web
    deps:
      - build

  migrate:
    cmds:
      - ./bin/queryops migrate up
    deps:
      - build

  migrate:down:
    cmds:
      - ./bin/queryops migrate down --steps 1
    deps:
      - build

  migrate:version:
    cmds:
      - ./bin/queryops migrate version
    deps:
      - build

  migrate:to:
    cmds:
      - ./bin/queryops migrate to {{.VERSION}}
    deps:
      - build

  migrate:force:
    cmds:
      - ./bin/queryops migrate force {{.VERSION}}
    deps:
      - build

  default:
    cmds:
      - task: live
